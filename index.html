<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—å·¥å…· v2.1</title>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #ffffff;
            --text: #1e293b;
            --card: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #f87171;
            --bg: #0f172a;
            --text: #e2e8f0;
            --card: #1e293b;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            color: var(--text);
            opacity: 0.7;
            margin-bottom: 20px;
        }

        .form-section {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.3em;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required {
            color: var(--error);
        }

        input, select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .input-hint {
            font-size: 12px;
            color: var(--text);
            opacity: 0.6;
            margin-top: 4px;
        }

        .input-error {
            border-color: var(--error) !important;
            background-color: rgba(239, 68, 68, 0.05);
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .metformin-section {
            border: 2px solid var(--warning);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.1));
        }

        .metformin-warning, .metformin-alert, .normal-info, .limit-warning {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .metformin-warning {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .metformin-alert {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b;
            border-left: 4px solid var(--error);
        }

        .normal-info {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .limit-warning {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .results {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border);
            margin-top: 25px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .results.show { display: block; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            background: var(--bg);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .result-label {
            font-weight: 500;
            color: var(--text);
        }

        .result-value {
            font-size: 1.2em;
            color: var(--primary);
            font-weight: 700;
        }

        .calc-type {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fef7cd, #fed7aa);
            color: #92400e;
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid var(--warning);
            margin-top: 25px;
            font-size: 13px;
            line-height: 1.6;
        }

        .disclaimer h3 {
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 700;
        }

        .highlight {
            font-weight: 700;
            color: #b45309;
        }

        .real-time-validation {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .validation-success { color: var(--success); }
        .validation-error { color: var(--error); }

        .formula-display {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text);
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            h1 { font-size: 2em; }
            .form-row { grid-template-columns: 1fr; gap: 15px; }
            .theme-toggle { position: relative; margin-bottom: 20px; }
            .btn-group { flex-direction: column; }
        }

        @media print {
            body { background: white; color: black; }
            .container { background: white; box-shadow: none; }
            .btn, .theme-toggle { display: none; }
            .no-print { display: none; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">ğŸŒ™</span>
                <span id="theme-text">å¤œé—´æ¨¡å¼</span>
            </div>
            <h1>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—å·¥å…·</h1>
            <div class="subtitle">CTAé€ å½±å‰‚ç”¨é‡ä¸BMIå­¦æœ¯å‚è€ƒè®¡ç®—ï¼ˆå«äºŒç”²åŒèƒè¯„ä¼°ï¼‰v2.1</div>
            <div style="margin-top: 15px; padding: 8px 16px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-block;">
                ğŸ’» ç¨‹åºå¼€å‘è€…ï¼šå½±åƒæ¶›å“¥
            </div>
        </div>
        
        <div class="form-section">
            <h2 class="section-title">
                <span>âš™ï¸</span>
                åŸºç¡€å‚æ•°è®¾ç½®
            </h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="height">èº«é«˜ (cm) <span class="required">*</span></label>
                    <input type="number" id="height" placeholder="è¯·è¾“å…¥èº«é«˜ï¼Œå¦‚ï¼š170" min="100" max="250" step="0.1" required>
                    <span class="real-time-validation" id="height-validation"></span>
                    <div class="input-hint">èŒƒå›´ï¼š100-250cm</div>
                    <div class="error-message" id="height-error">èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´</div>
                </div>
                <div class="form-group">
                    <label for="weight">ä½“é‡ (kg) <span class="required">*</span></label>
                    <input type="number" id="weight" placeholder="è¯·è¾“å…¥ä½“é‡ï¼Œå¦‚ï¼š70" min="20" max="200" step="0.1" required>
                    <span class="real-time-validation" id="weight-validation"></span>
                    <div class="input-hint">èŒƒå›´ï¼š20-200kg</div>
                    <div class="error-message" id="weight-error">ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´</div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="heartRate">å¿ƒç‡å‚æ•°</label>
                    <select id="heartRate">
                        <option value="80">â‰¤80 æ¬¡/åˆ†</option>
                        <option value="81">>80 æ¬¡/åˆ†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="examType">æ£€æŸ¥ç±»å‹</label>
                    <select id="examType">
                        <option value="coronary">å† è„‰CTA</option>
                        <option value="triple">èƒ¸ç—›ä¸‰è”</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-section metformin-section" id="metforminSection">
            <h2 class="section-title">
                <span>ğŸ’Š</span>
                äºŒç”²åŒèƒç”¨è¯è¯„ä¼°ï¼ˆ2021ç‰ˆCKD-EPIï¼‰
            </h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="metforminStatus">48å°æ—¶å†…æ˜¯å¦æœç”¨äºŒç”²åŒèƒï¼Ÿ</label>
                    <select id="metforminStatus" onchange="handleMetforminChange()">
                        <option value="no">å¦ï¼Œæœªæœç”¨</option>
                        <option value="yes">æ˜¯ï¼Œæœ‰æœç”¨</option>
                        <option value="unknown">ä¸ç¡®å®š</option>
                    </select>
                </div>
                <div class="form-group" id="metforminDoseGroup" style="display: none;">
                    <label for="metforminDose">äºŒç”²åŒèƒå‰‚é‡ï¼ˆmg/æ—¥ï¼‰</label>
                    <select id="metforminDose">
                        <option value="500">500mg/æ—¥</option>
                        <option value="850">850mg/æ—¥</option>
                        <option value="1000">1000mg/æ—¥</option>
                        <option value="1500">1500mg/æ—¥</option>
                        <option value="2000">2000mg/æ—¥</option>
                        <option value="other">å…¶ä»–å‰‚é‡</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row" id="renalFunctionGroup" style="display: none;">
                <div class="form-group">
                    <label for="creatinine">è¡€è‚Œé…å€¼ (Î¼mol/L) <span class="required">*</span></label>
                    <input type="number" id="creatinine" placeholder="è¯·è¾“å…¥è¡€è‚Œé…å€¼ï¼Œå¦‚ï¼š80" min="30" max="500" step="1">
                    <span class="real-time-validation" id="creatinine-validation"></span>
                    <div class="input-hint">èŒƒå›´ï¼š30-500 Î¼mol/Lï¼Œç”¨äºè¯„ä¼°è‚¾åŠŸèƒ½</div>
                    <div class="error-message" id="creatinine-error">è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500 Î¼mol/Lä¹‹é—´</div>
                    <div class="formula-display" id="formulaDisplay" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="age">å¹´é¾„ (å²) <span class="required">*</span></label>
                    <input type="number" id="age" placeholder="è¯·è¾“å…¥å¹´é¾„ï¼Œå¦‚ï¼š45" min="18" max="120" step="1">
                    <span class="real-time-validation" id="age-validation"></span>
                    <div class="input-hint">èŒƒå›´ï¼š18-120å²</div>
                    <div class="error-message" id="age-error">å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´</div>
                </div>
            </div>

            <div class="form-row" id="genderGroup" style="display: none;">
                <div class="form-group">
                    <label for="gender">æ€§åˆ« <span class="required">*</span></label>
                    <select id="gender" onchange="updateFormulaDisplay()">
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                    </select>
                </div>
            </div>

            <div id="metforminInfo">
                <div class="normal-info">
                    <strong>âœ… æ— äºŒç”²åŒèƒç”¨è¯é£é™©ï¼š</strong><br>
                    æ‚£è€…æœªæœç”¨äºŒç”²åŒèƒï¼Œæ— éœ€è€ƒè™‘äºŒç”²åŒèƒ-é€ å½±å‰‚ç›¸äº’ä½œç”¨é£é™©ã€‚
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="calculate()" id="calculateBtn">
                    <span>ğŸ§®</span> è®¡ç®—å‚è€ƒæ•°å€¼
                </button>
                <button class="btn btn-secondary" onclick="exportToPDF()" id="pdfBtn" disabled>
                    <span>ğŸ“‘</span> å¯¼å‡ºPDF
                </button>
            </div>
        </div>

        <div class="results" id="results">
            <h2 class="section-title">
                <span>ğŸ“Š</span>
                è®¡ç®—ç»“æœ
            </h2>
            <div id="calculationResults"></div>
        </div>

        <div class="disclaimer">
            <h3>âš ï¸ é‡è¦ä½¿ç”¨å£°æ˜</h3>
            <p><span class="highlight">ä¸“ä¸šèƒŒæ™¯è¦æ±‚ï¼š</span>ä½¿ç”¨è€…é¡»æ˜¯åœ¨åŒ»å­¦å½±åƒç§‘å·¥ä½œçš„ä¸“ä¸šäººå‘˜ï¼Œç†Ÿæ‚‰CTæ£€æŸ¥æµç¨‹å’Œé€ å½±å‰‚ä½¿ç”¨è§„èŒƒã€‚</p>
            <p><span class="highlight">è®¾å¤‡ä¾æ®ï¼š</span>æœ¬å·¥å…·è®¡ç®—å…¬å¼åŸºäºè”å½±CT960+è®¾å¤‡çš„æŠ€æœ¯å‚æ•°å’Œä¸´åºŠç ”ç©¶æ•°æ®ã€‚</p>
            <p><span class="highlight">å­¦æœ¯ç”¨é€”ï¼š</span>ä»…ä¾›å½±åƒæŠ€æœ¯æ•™å­¦ã€å­¦æœ¯ç ”ç©¶ä½¿ç”¨ï¼Œä¸¥ç¦ç”¨äºä¸´åºŠè¯Šæ–­æˆ–æ²»ç–—å†³ç­–ã€‚</p>
            <p><span class="highlight">äºŒç”²åŒèƒè¯„ä¼°ï¼š</span>é›†æˆçš„äºŒç”²åŒèƒ-é€ å½±å‰‚ç›¸äº’ä½œç”¨è¯„ä¼°ä»…ä¾›å‚è€ƒï¼Œä¸´åºŠå†³ç­–éœ€ç»“åˆå®Œæ•´ç—…å²å’Œå®éªŒå®¤æ£€æŸ¥ã€‚</p>
            <p><span class="highlight">eGFRè®¡ç®—ï¼š</span>é‡‡ç”¨2021ç‰ˆCKD-EPIå…¬å¼ï¼ˆæ— ç§æ—ç³»æ•°ï¼‰ï¼Œé€‚ç”¨äºä¸­å›½äººç¾¤ï¼Œè®¡ç®—æ–¹å¼å·²ä¼˜åŒ–ä¿®æ­£ã€‚</p>
            <p><span class="highlight">å®‰å…¨é™åˆ¶ï¼š</span>ç¨‹åºå·²è®¾ç½®é€ å½±å‰‚ç”¨é‡å’Œæ³¨å°„æµé€Ÿçš„å®‰å…¨ä¸Šé™ï¼Œä½†å®é™…ä½¿ç”¨éœ€ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µå……åˆ†è¯„ä¼°è¡€ç®¡é€šè·¯å’Œè‚¾åŠŸèƒ½ã€‚</p>
            <p style="margin-top: 15px; font-weight: 700; color: #b45309; border-top: 1px solid #fed7aa; padding-top: 15px;">
                å¼€å‘è€…ä¸æ‰¿æ‹…ä»»ä½•ç›´æ¥æˆ–é—´æ¥çš„æ³•å¾‹è´£ä»»ï¼ä½¿ç”¨å³è¡¨ç¤ºåŒæ„æœ¬å£°æ˜ã€‚
            </p>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const appState = {
            isDarkMode: false,
            currentResults: null
        };

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            try {
                appState.isDarkMode = !appState.isDarkMode;
                const body = document.body;
                const themeIcon = document.getElementById('theme-icon');
                const themeText = document.getElementById('theme-text');
                
                if (appState.isDarkMode) {
                    body.setAttribute('data-theme', 'dark');
                    if (themeIcon) themeIcon.textContent = 'â˜€ï¸';
                    if (themeText) themeText.textContent = 'æ—¥é—´æ¨¡å¼';
                } else {
                    body.removeAttribute('data-theme');
                    if (themeIcon) themeIcon.textContent = 'ğŸŒ™';
                    if (themeText) themeText.textContent = 'å¤œé—´æ¨¡å¼';
                }
            } catch (error) {
                console.error('ä¸»é¢˜åˆ‡æ¢å‡ºé”™:', error);
                showNotification('âš ï¸ ä¸»é¢˜åˆ‡æ¢å¤±è´¥', 'warning');
            }
        }

        // ä¿®æ­£ç‰ˆ2021å¹´CKD-EPI eGFRè®¡ç®—å‡½æ•°ï¼ˆç›´æ¥ä½¿ç”¨Î¼mol/Lï¼‰
        function calculateEGFR_2021_Corrected(creatinine_umol, age, gender) {
            let eGFR;
            
            if (gender === 'female') {
                // å¥³æ€§é˜ˆå€¼ï¼š62 Î¼mol/L (ç›¸å½“äº0.7 mg/dL)
                if (creatinine_umol <= 62) {
                    // Scr â‰¤ 62 Î¼mol/L: ä½¿ç”¨ -0.241 æŒ‡æ•°
                    eGFR = 142 * Math.pow(creatinine_umol / 62, -0.241) * Math.pow(0.9938, age) * 1.012;
                } else {
                    // Scr > 62 Î¼mol/L: ä½¿ç”¨ -1.2 æŒ‡æ•°
                    eGFR = 142 * Math.pow(62 / creatinine_umol, 1.2) * Math.pow(0.9938, age) * 1.012;
                }
            } else {
                // ç”·æ€§é˜ˆå€¼ï¼š80 Î¼mol/L (ç›¸å½“äº0.9 mg/dL)
                if (creatinine_umol <= 80) {
                    // Scr â‰¤ 80 Î¼mol/L: ä½¿ç”¨ -0.302 æŒ‡æ•°
                    eGFR = 142 * Math.pow(creatinine_umol / 80, -0.302) * Math.pow(0.9938, age);
                } else {
                    // Scr > 80 Î¼mol/L: ä½¿ç”¨ -1.2 æŒ‡æ•°
                    eGFR = 142 * Math.pow(80 / creatinine_umol, 1.2) * Math.pow(0.9938, age);
                }
            }
            
            return Math.round(eGFR);
        }

        // æ›´æ–°å…¬å¼æ˜¾ç¤º
        function updateFormulaDisplay() {
            const gender = document.getElementById('gender').value;
            const creatinine = parseFloat(document.getElementById('creatinine').value);
            const formulaDisplay = document.getElementById('formulaDisplay');
            
            if (!creatinine || creatinine < 30 || creatinine > 500) {
                formulaDisplay.style.display = 'none';
                return;
            }
            
            let formulaText = '';
            let threshold = '';
            let currentFormula = '';
            
            if (gender === 'female') {
                threshold = '62 Î¼mol/L';
                if (creatinine <= 62) {
                    currentFormula = `eGFR = 142 Ã— (${creatinine}/62)^(-0.241) Ã— 0.9938^å¹´é¾„ Ã— 1.012`;
                    formulaText = `å¥³æ€§ï¼ŒScr â‰¤ ${threshold}ï¼Œä½¿ç”¨å…¬å¼ï¼š<br>${currentFormula}`;
                } else {
                    currentFormula = `eGFR = 142 Ã— (62/${creatinine})^1.2 Ã— 0.9938^å¹´é¾„ Ã— 1.012`;
                    formulaText = `å¥³æ€§ï¼ŒScr > ${threshold}ï¼Œä½¿ç”¨å…¬å¼ï¼š<br>${currentFormula}`;
                }
            } else {
                threshold = '80 Î¼mol/L';
                if (creatinine <= 80) {
                    currentFormula = `eGFR = 142 Ã— (${creatinine}/80)^(-0.302) Ã— 0.9938^å¹´é¾„`;
                    formulaText = `ç”·æ€§ï¼ŒScr â‰¤ ${threshold}ï¼Œä½¿ç”¨å…¬å¼ï¼š<br>${currentFormula}`;
                } else {
                    currentFormula = `eGFR = 142 Ã— (80/${creatinine})^1.2 Ã— 0.9938^å¹´é¾„`;
                    formulaText = `ç”·æ€§ï¼ŒScr > ${threshold}ï¼Œä½¿ç”¨å…¬å¼ï¼š<br>${currentFormula}`;
                }
            }
            
            formulaDisplay.innerHTML = formulaText;
            formulaDisplay.style.display = 'block';
        }

        // å®æ—¶è¾“å…¥éªŒè¯
        function setupRealTimeValidation() {
            try {
                const validationRules = {
                    height: { min: 100, max: 250, message: 'èº«é«˜å¿…é¡»åœ¨100-250cmä¹‹é—´' },
                    weight: { min: 20, max: 200, message: 'ä½“é‡å¿…é¡»åœ¨20-200kgä¹‹é—´' },
                    creatinine: { min: 30, max: 500, message: 'è¡€è‚Œé…å€¼å¿…é¡»åœ¨30-500Î¼mol/Lä¹‹é—´' },
                    age: { min: 18, max: 120, message: 'å¹´é¾„å¿…é¡»åœ¨18-120å²ä¹‹é—´' }
                };

                Object.keys(validationRules).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const validation = document.getElementById(`${fieldId}-validation`);
                    const error = document.getElementById(`${fieldId}-error`);
                    
                    if (field) {
                        field.addEventListener('input', function() {
                            try {
                                validateField(this, validationRules[fieldId], validation, error);
                                updateProgress();
                                
                                // å¦‚æœæ˜¯è‚Œé…å€¼å˜åŒ–ï¼Œæ›´æ–°å…¬å¼æ˜¾ç¤º
                                if (fieldId === 'creatinine') {
                                    updateFormulaDisplay();
                                }
                            } catch (error) {
                                console.error(`éªŒè¯å­—æ®µ${fieldId}æ—¶å‡ºé”™:`, error);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('è®¾ç½®å®æ—¶éªŒè¯æ—¶å‡ºé”™:', error);
                showNotification('âš ï¸ è¾“å…¥éªŒè¯åŠŸèƒ½å¼‚å¸¸', 'warning');
            }
        }

        function validateField(field, rule, validationEl, errorEl) {
            try {
                const value = parseFloat(field.value);
                const isValid = !isNaN(value) && value >= rule.min && value <= rule.max;
                
                if (field.value === '') {
                    field.classList.remove('input-error');
                    if (validationEl) validationEl.textContent = '';
                    if (errorEl) errorEl.style.display = 'none';
                    return null;
                }
                
                if (isValid) {
                    field.classList.remove('input-error');
                    if (validationEl) {
                        validationEl.textContent = 'âœ“';
                        validationEl.className = 'real-time-validation validation-success';
                    }
                    if (errorEl) errorEl.style.display = 'none';
                    return true;
                } else {
                    field.classList.add('input-error');
                    if (validationEl) {
                        validationEl.textContent = 'âœ—';
                        validationEl.className = 'real-time-validation validation-error';
                    }
                    if (errorEl) errorEl.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error('å­—æ®µéªŒè¯å‡ºé”™:', error);
                return false;
            }
        }

        function updateProgress() {
            try {
                const requiredFields = ['height', 'weight'];
                const metforminStatus = document.getElementById('metforminStatus').value;
                
                if (metforminStatus === 'yes') {
                    requiredFields.push('creatinine', 'age');
                }
                
                let completedFields = 0;
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value !== '') {
                        completedFields++;
                    }
                });
                
                const progress = (completedFields / requiredFields.length) * 100;
                const progressBar = document.getElementById('progress');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                
                const calculateBtn = document.getElementById('calculateBtn');
                if (calculateBtn) {
                    calculateBtn.disabled = progress < 100;
                }
            } catch (error) {
                console.error('æ›´æ–°è¿›åº¦æ¡å‡ºé”™:', error);
            }
        }

        // å¢å¼ºçš„äºŒç”²åŒèƒé£é™©è¯„ä¼°
        function assessMetforminRisk(eGFR, dose, age) {
            let riskLevel = 'low';
            let recommendations = [];
            let clinicalAction = '';
            
            if (eGFR >= 60) {
                riskLevel = 'low';
                clinicalAction = 'æ ‡å‡†å¤„ç†';
                recommendations = [
                    'è‚¾åŠŸèƒ½æ­£å¸¸ï¼Œé€ å½±å‰åæš‚åœäºŒç”²åŒèƒ48å°æ—¶',
                    'é€ å½±åç›‘æµ‹è‚¾åŠŸèƒ½ï¼Œæ— å¼‚å¸¸å¯æ¢å¤ç”¨è¯',
                    'å»ºè®®é€ å½±å‰åå……åˆ†æ°´åŒ–'
                ];
            } else if (eGFR >= 45) {
                riskLevel = 'moderate';
                clinicalAction = 'è°¨æ…ç›‘æµ‹';
                recommendations = [
                    'è½»åº¦è‚¾åŠŸèƒ½ä¸å…¨ï¼Œéœ€è°¨æ…è¯„ä¼°',
                    'é€ å½±å‰åæš‚åœäºŒç”²åŒèƒ48-72å°æ—¶',
                    'é€ å½±å48-72å°æ—¶å¤æŸ¥è‚¾åŠŸèƒ½',
                    'å»ºè®®é™è„‰æ°´åŒ–ï¼š0.9% NaCl 1ml/kg/hï¼Œæ£€æŸ¥å‰6-12hå¼€å§‹'
                ];
            } else if (eGFR >= 30) {
                riskLevel = 'high';
                clinicalAction = 'é«˜é£é™©å¤„ç†';
                recommendations = [
                    'ä¸­åº¦è‚¾åŠŸèƒ½ä¸å…¨ï¼Œé«˜é£é™©',
                    'é€ å½±å‰åæš‚åœäºŒç”²åŒèƒ72å°æ—¶',
                    'è€ƒè™‘å‡å°‘é€ å½±å‰‚ç”¨é‡è‡³æ ‡å‡†ç”¨é‡çš„80%',
                    'å¿…é¡»é™è„‰æ°´åŒ–ï¼š0.9% NaCl 1ml/kg/h Ã— 12h',
                    'ä½¿ç”¨ç­‰æ¸—é€ å½±å‰‚ï¼ˆç¢˜å…‹æ²™é†‡ï¼‰',
                    'é€ å½±å72å°æ—¶å†…å¯†åˆ‡ç›‘æµ‹è‚¾åŠŸèƒ½'
                ];
            } else {
                riskLevel = 'very-high';
                clinicalAction = 'æé«˜é£é™© - é¿å…æ£€æŸ¥';
                recommendations = [
                    'é‡åº¦è‚¾åŠŸèƒ½ä¸å…¨ï¼Œæé«˜é£é™©',
                    'å¼ºçƒˆå»ºè®®é¿å…ä½¿ç”¨é€ å½±å‰‚',
                    'å¦‚å¿…é¡»æ£€æŸ¥ï¼Œéœ€å†…åˆ†æ³Œç§‘å’Œè‚¾å†…ç§‘ä¼šè¯Š',
                    'è€ƒè™‘æ›¿ä»£æ£€æŸ¥æ–¹æ³•ï¼ˆMRIã€è¶…å£°ç­‰ï¼‰',
                    'å¦‚æ— æ³•é¿å…ï¼Œéœ€é€æå‡†å¤‡'
                ];
            }

            // å¹´é¾„å› ç´ è°ƒæ•´
            if (age >= 75 && eGFR < 60) {
                recommendations.unshift('é«˜é¾„æ‚£è€…ï¼Œå¢åŠ ç›‘æµ‹é¢‘æ¬¡');
            }
            
            return { 
                riskLevel, 
                recommendations, 
                clinicalAction,
                riskScore: calculateRiskScore(eGFR, age, dose)
            };
        }

        function calculateRiskScore(eGFR, age, dose) {
            let score = 0;
            
            // eGFRè¯„åˆ†
            if (eGFR >= 60) score += 1;
            else if (eGFR >= 45) score += 2;
            else if (eGFR >= 30) score += 3;
            else score += 4;
            
            // å¹´é¾„è¯„åˆ†
            if (age >= 75) score += 1;
            else if (age >= 65) score += 0.5;
            
            // å‰‚é‡è¯„åˆ†
            const doseNum = parseInt(dose);
            if (doseNum >= 2000) score += 1;
            else if (doseNum >= 1500) score += 0.5;
            
            return score;
        }

        // äºŒç”²åŒèƒçŠ¶æ€å˜åŒ–å¤„ç†
        function handleMetforminChange() {
            try {
                const metforminStatus = document.getElementById('metforminStatus').value;
                const metforminDoseGroup = document.getElementById('metforminDoseGroup');
                const renalFunctionGroup = document.getElementById('renalFunctionGroup');
                const genderGroup = document.getElementById('genderGroup');
                const metforminInfo = document.getElementById('metforminInfo');

                if (metforminStatus === 'yes') {
                    metforminDoseGroup.style.display = 'block';
                    renalFunctionGroup.style.display = 'block';
                    genderGroup.style.display = 'block';
                    
                    metforminInfo.innerHTML = `
                        <div class="metformin-warning">
                            <strong>âš ï¸ äºŒç”²åŒèƒç”¨è¯æé†’ï¼š</strong><br>
                            â€¢ é€ å½±å‰‚å¯èƒ½å½±å“è‚¾åŠŸèƒ½ï¼Œå¢åŠ ä¹³é…¸é…¸ä¸­æ¯’é£é™©<br>
                            â€¢ å»ºè®®é€ å½±æ£€æŸ¥å‰å48-72å°æ—¶æš‚åœäºŒç”²åŒèƒ<br>
                            â€¢ éœ€è¯„ä¼°æ‚£è€…è‚¾åŠŸèƒ½(eGFR)å†³å®šæ˜¯å¦ç»§ç»­ç”¨è¯<br>
                            â€¢ è¯·è¾“å…¥ç›¸å…³å‚æ•°ä»¥è¿›è¡Œç²¾ç¡®é£é™©è¯„ä¼°ï¼ˆä½¿ç”¨2021 CKD-EPIå…¬å¼ï¼‰
                        </div>
                    `;
                } else if (metforminStatus === 'unknown') {
                    metforminDoseGroup.style.display = 'none';
                    renalFunctionGroup.style.display = 'none';
                    genderGroup.style.display = 'none';
                    
                    metforminInfo.innerHTML = `
                        <div class="metformin-alert">
                            <strong>ğŸš¨ ç”¨è¯å²ä¸æ˜ç¡®è­¦å‘Šï¼š</strong><br>
                            â€¢ å¼ºçƒˆå»ºè®®è¯¦ç»†è¯¢é—®æ‚£è€…ç”¨è¯å²<br>
                            â€¢ ç³–å°¿ç—…æ‚£è€…å¸¸è§„ä½¿ç”¨äºŒç”²åŒèƒ<br>
                            â€¢ å¦‚æ— æ³•ç¡®è®¤ï¼Œå»ºè®®æŒ‰æœç”¨äºŒç”²åŒèƒå¤„ç†<br>
                            â€¢ é€ å½±å‰åº”æš‚åœäºŒç”²åŒèƒ48-72å°æ—¶
                        </div>
                    `;
                } else {
                    metforminDoseGroup.style.display = 'none';
                    renalFunctionGroup.style.display = 'none';
                    genderGroup.style.display = 'none';
                    
                    metforminInfo.innerHTML = `
                        <div class="normal-info">
                            <strong>âœ… æ— äºŒç”²åŒèƒç”¨è¯é£é™©ï¼š</strong><br>
                            æ‚£è€…æœªæœç”¨äºŒç”²åŒèƒï¼Œæ— éœ€è€ƒè™‘äºŒç”²åŒèƒ-é€ å½±å‰‚ç›¸äº’ä½œç”¨é£é™©ã€‚
                        </div>
                    `;
                }
                
                updateProgress();
                
                // é‡ç½®å…¬å¼æ˜¾ç¤º
                const formulaDisplay = document.getElementById('formulaDisplay');
                if (formulaDisplay) {
                    formulaDisplay.style.display = 'none';
                }
                
            } catch (error) {
                console.error('äºŒç”²åŒèƒçŠ¶æ€æ›´æ–°å‡ºé”™:', error);
                showNotification('âš ï¸ ç•Œé¢æ›´æ–°å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'warning');
            }
        }

        // ä¸»è®¡ç®—å‡½æ•°
        function calculate() {
            try {
                const height = parseFloat(document.getElementById('height').value);
                const weight = parseFloat(document.getElementById('weight').value);
                const heartRate = parseInt(document.getElementById('heartRate').value);
                const examType = document.getElementById('examType').value;
                const metforminStatus = document.getElementById('metforminStatus').value;

                // ç»¼åˆè¾“å…¥éªŒè¯
                const validationErrors = [];
                
                if (!height || height < 100 || height > 250) {
                    validationErrors.push('èº«é«˜èŒƒå›´åº”åœ¨100-250cmä¹‹é—´');
                }
                if (!weight || weight < 20 || weight > 200) {
                    validationErrors.push('ä½“é‡èŒƒå›´åº”åœ¨20-200kgä¹‹é—´');
                }

                // äºŒç”²åŒèƒç›¸å…³éªŒè¯
                let metforminRisk = null;
                if (metforminStatus === 'yes') {
                    const creatinine = parseFloat(document.getElementById('creatinine').value);
                    const age = parseInt(document.getElementById('age').value);
                    const gender = document.getElementById('gender').value;
                    const dose = document.getElementById('metforminDose').value;

                    if (!creatinine || creatinine < 30 || creatinine > 500) {
                        validationErrors.push('è¡€è‚Œé…å€¼èŒƒå›´åº”åœ¨30-500 Î¼mol/Lä¹‹é—´');
                    }
                    if (!age || age < 18 || age > 120) {
                        validationErrors.push('å¹´é¾„èŒƒå›´åº”åœ¨18-120å²ä¹‹é—´');
                    }

                    if (validationErrors.length === 0) {
                        // ä½¿ç”¨ä¿®æ­£ç‰ˆeGFRè®¡ç®—
                        const eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
                        metforminRisk = assessMetforminRisk(eGFR, dose, age);
                        metforminRisk.eGFR = eGFR;
                        metforminRisk.creatinine = creatinine;
                        metforminRisk.age = age;
                        metforminRisk.gender = gender;
                        metforminRisk.dose = dose;
                        metforminRisk.calculationMethod = '2021ç‰ˆCKD-EPIï¼ˆç›´æ¥è®¡ç®—ï¼‰';
                    }
                }

                if (validationErrors.length > 0) {
                    showNotification('âŒ è¾“å…¥éªŒè¯å¤±è´¥ï¼š\n' + validationErrors.join('\n'), 'error');
                    return;
                }

                // æ‰§è¡Œè®¡ç®—
                const results = performCalculations(height, weight, heartRate, examType, metforminStatus, metforminRisk);
                displayResults(results);
                
                // ä¿å­˜åˆ°çŠ¶æ€
                appState.currentResults = results;

                // å¯ç”¨PDFå¯¼å‡ºæŒ‰é’®
                document.getElementById('pdfBtn').disabled = false;
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showNotification('âœ… è®¡ç®—å®Œæˆï¼ä½¿ç”¨ä¿®æ­£ç‰ˆeGFRå…¬å¼', 'success');
                
            } catch (error) {
                console.error('è®¡ç®—è¿‡ç¨‹å‡ºé”™:', error);
                showNotification('âŒ è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°æ®', 'error');
            }
        }

        function performCalculations(height, weight, heartRate, examType, metforminStatus, metforminRisk) {
            // è®¡ç®—BMI
            const bmi = weight / Math.pow(height / 100, 2);
            
            // è®¡ç®—é€ å½±å‰‚ç”¨é‡
            let contrastVolume;
            let maxVolume;
            
            if (examType === 'coronary') {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85);
                maxVolume = 60;
            } else {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85) + 15;
                maxVolume = 75;
            }

            // äºŒç”²åŒèƒæ‚£è€…çš„é€ å½±å‰‚ç”¨é‡è°ƒæ•´
            let contrastAdjustment = '';
            if (metforminRisk && metforminRisk.eGFR < 60) {
                const reductionFactor = metforminRisk.eGFR < 45 ? 0.8 : 0.9;
                const originalVolume = contrastVolume;
                contrastVolume = contrastVolume * reductionFactor;
                contrastAdjustment = `è‚¾åŠŸèƒ½ä¸å…¨è°ƒæ•´ï¼š${originalVolume.toFixed(1)}ml â†’ ${contrastVolume.toFixed(1)}ml`;
            }

            // åº”ç”¨æœ€å¤§ç”¨é‡é™åˆ¶
            const isVolumeExceeded = contrastVolume > maxVolume;
            const originalVolume = contrastVolume;
            if (isVolumeExceeded) {
                contrastVolume = maxVolume;
            }

            // è®¡ç®—æ³¨å°„æµé€Ÿ
            let flowRate = examType === 'coronary' ? 
                contrastVolume / 12 : 
                (contrastVolume - 15) / 12;

            const isFlowRateExceeded = flowRate > 5.0;
            const originalFlowRate = flowRate;
            if (isFlowRateExceeded) {
                flowRate = 5.0;
            }

            return {
                height, weight, heartRate, examType, bmi,
                contrastVolume, flowRate, maxVolume,
                isVolumeExceeded, originalVolume,
                isFlowRateExceeded, originalFlowRate,
                metforminStatus, metforminRisk,
                contrastAdjustment,
                timestamp: new Date()
            };
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('calculationResults');
            
            // BMIè¯„ä¼°
            let bmiStatus, bmiClass;
            if (results.bmi < 18.5) {
                bmiStatus = 'åç˜¦';
                bmiClass = 'limit-warning';
            } else if (results.bmi < 24) {
                bmiStatus = 'æ­£å¸¸';
                bmiClass = 'normal-info';
            } else if (results.bmi < 28) {
                bmiStatus = 'è¶…é‡';
                bmiClass = 'limit-warning';
            } else {
                bmiStatus = 'è‚¥èƒ–';
                bmiClass = 'limit-warning';
            }

            const examTypeText = results.examType === 'coronary' ? 'å† è„‰CTA' : 'èƒ¸ç—›ä¸‰è”';
            const heartRateText = results.heartRate <= 80 ? 'â‰¤80 æ¬¡/åˆ†' : '>80 æ¬¡/åˆ†';
            
            let metforminStatusText = '';
            switch(results.metforminStatus) {
                case 'yes': metforminStatusText = 'æ˜¯ï¼Œæœ‰æœç”¨'; break;
                case 'no': metforminStatusText = 'å¦ï¼Œæœªæœç”¨'; break;
                case 'unknown': metforminStatusText = 'ä¸ç¡®å®š'; break;
            }

            // äºŒç”²åŒèƒé£é™©è¯„ä¼°ç»“æœ
            let metforminAssessment = '';
            if (results.metforminRisk) {
                const risk = results.metforminRisk;
                let riskColor = '';
                
                switch(risk.riskLevel) {
                    case 'low': riskColor = '#22c55e'; break;
                    case 'moderate': riskColor = '#f59e0b'; break;
                    case 'high': riskColor = '#ef4444'; break;
                    case 'very-high': riskColor = '#dc2626'; break;
                }

                metforminAssessment = `
                    <div class="result-item">
                        <span class="result-label">ğŸ§ª è¡€è‚Œé…å€¼</span>
                        <span class="result-value">${risk.creatinine} Î¼mol/L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ”¬ eGFR (2021ç‰ˆCKD-EPI)</span>
                        <span class="result-value">${risk.eGFR} ml/min/1.73mÂ²</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">âš—ï¸ è®¡ç®—æ–¹æ³•</span>
                        <span class="result-value" style="font-size: 0.9em;">${risk.calculationMethod}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">âš ï¸ äºŒç”²åŒèƒé£é™©ç­‰çº§</span>
                        <span class="result-value" style="color: ${riskColor};">${risk.clinicalAction}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ“ˆ é£é™©è¯„åˆ†</span>
                        <span class="result-value">${risk.riskScore.toFixed(1)} åˆ†</span>
                    </div>
                    <div class="${risk.riskLevel === 'low' ? 'normal-info' : 'metformin-alert'}">
                        <strong>ğŸ¥ ä¸´åºŠå¤„ç†å»ºè®®ï¼š</strong><br>
                        ${risk.recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
                    </div>
                `;
            } else if (results.metforminStatus === 'unknown') {
                metforminAssessment = `
                    <div class="metformin-alert">
                        <strong>ğŸš¨ ç”¨è¯å²ä¸æ˜ç¡® - æŒ‰é«˜é£é™©å¤„ç†ï¼š</strong><br>
                        â€¢ å¼ºçƒˆå»ºè®®è¯¦ç»†è¯¢é—®æ‚£è€…ç³–å°¿ç—…ç”¨è¯å²<br>
                        â€¢ å¦‚æ— æ³•ç¡®è®¤ï¼Œå»ºè®®é€ å½±å‰48-72å°æ—¶åœç”¨æ‰€æœ‰é™ç³–è¯<br>
                        â€¢ å¿…è¦æ—¶å†…åˆ†æ³Œç§‘ä¼šè¯Š
                    </div>
                `;
            } else {
                metforminAssessment = `
                    <div class="normal-info">
                        <strong>âœ… æ— äºŒç”²åŒèƒç›¸å…³é£é™©</strong><br>
                        æ‚£è€…æœªæœç”¨äºŒç”²åŒèƒï¼Œå¯æŒ‰æ ‡å‡†æµç¨‹è¿›è¡Œé€ å½±æ£€æŸ¥ã€‚
                    </div>
                `;
            }
            
            // ç”Ÿæˆé™åˆ¶æç¤º
            let limitWarning = '';
            if (results.isVolumeExceeded) {
                limitWarning += `
                    <div class="limit-warning">
                        <strong>ğŸš¨ é€ å½±å‰‚ç”¨é‡é™åˆ¶æç¤ºï¼š</strong><br>
                        ç†è®ºè®¡ç®—ç”¨é‡ï¼š${results.originalVolume.toFixed(1)}ml<br>
                        å®‰å…¨é™åˆ¶ç”¨é‡ï¼š${results.contrastVolume.toFixed(1)}mlï¼ˆ${examTypeText}æœ€å¤§ç”¨é‡ï¼š${results.maxVolume}mlï¼‰<br>
                        <strong>å»ºè®®ï¼š</strong>å·²åº”ç”¨å®‰å…¨ä¸Šé™ï¼Œè¯·ç»“åˆæ‚£è€…å…·ä½“æƒ…å†µè¯„ä¼°ã€‚
                    </div>
                `;
            }
            
            if (results.isFlowRateExceeded) {
                limitWarning += `
                    <div class="limit-warning">
                        <strong>ğŸš¨ æ³¨å°„æµé€Ÿé™åˆ¶æç¤ºï¼š</strong><br>
                        ç†è®ºè®¡ç®—æµé€Ÿï¼š${results.originalFlowRate.toFixed(2)}ml/s<br>
                        å®‰å…¨é™åˆ¶æµé€Ÿï¼š${results.flowRate.toFixed(2)}ml/sï¼ˆæœ€å¤§æµé€Ÿï¼š5.0ml/sï¼‰<br>
                        <strong>å»ºè®®ï¼š</strong>å·²åº”ç”¨å®‰å…¨ä¸Šé™ï¼Œå¯è€ƒè™‘å»¶é•¿æ³¨å°„æ—¶é—´æˆ–è°ƒæ•´æ–¹æ¡ˆã€‚
                    </div>
                `;
            }

            if (results.contrastAdjustment) {
                limitWarning += `
                    <div class="limit-warning">
                        <strong>ğŸ©º è‚¾åŠŸèƒ½è°ƒæ•´æç¤ºï¼š</strong><br>
                        ${results.contrastAdjustment}<br>
                        <strong>åŸå› ï¼š</strong>è‚¾åŠŸèƒ½ä¸å…¨æ‚£è€…å‡å°‘é€ å½±å‰‚ç”¨é‡ä»¥é™ä½è‚¾æ¯’æ€§é£é™©ã€‚
                    </div>
                `;
            }
            
            resultsContent.innerHTML = `
                <div class="calc-type">
                    è®¡ç®—æ¨¡å¼ï¼š${examTypeText} | å¿ƒç‡ï¼š${heartRateText} | äºŒç”²åŒèƒï¼š${metforminStatusText}
                    <div style="float: right; font-size: 12px;">
                        è®¡ç®—æ—¶é—´ï¼š${results.timestamp.toLocaleString()}
                    </div>
                </div>
                
                <div class="result-item">
                    <span class="result-label">ğŸ“ èº«é«˜</span>
                    <span class="result-value">${results.height} cm</span>
                </div>
                <div class="result-item">
                    <span class="result-label">âš–ï¸ ä½“é‡</span>
                    <span class="result-value">${results.weight} kg</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ğŸ“Š BMIæŒ‡æ•°</span>
                    <span class="result-value">${results.bmi.toFixed(2)}</span>
                </div>
                
                <div class="${bmiClass}">
                    <strong>BMIè¯„ä¼°ï¼š</strong>${bmiStatus}
                </div>
                
                ${metforminAssessment}
                
                <div class="result-item">
                    <span class="result-label">ğŸ’‰ é€ å½±å‰‚ç”¨é‡</span>
                    <span class="result-value" style="color: ${results.isVolumeExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.contrastVolume.toFixed(1)} ml
                    </span>
                </div>
                <div class="result-item">
                    <span class="result-label">âš¡ æ³¨å°„æµé€Ÿ</span>
                    <span class="result-value" style="color: ${results.isFlowRateExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.flowRate.toFixed(2)} ml/s
                    </span>
                </div>
                
                ${limitWarning}
                
                <div class="normal-info">
                    <strong>ğŸ“‹ è®¡ç®—ä¾æ®ï¼š</strong><br>
                    <strong>eGFRå…¬å¼ï¼š</strong>2021ç‰ˆCKD-EPIè‚¾å°çƒæ»¤è¿‡ç‡æ–¹ç¨‹ï¼ˆæ— ç§æ—ç³»æ•°ï¼Œç›´æ¥ä½¿ç”¨Î¼mol/Lï¼‰<br>
                    <strong>é€ å½±å‰‚ç”¨é‡ï¼š</strong>${results.examType === 'coronary' ? 
                        (results.heartRate <= 80 ? 'å† è„‰CTAå¿ƒç‡â‰¤80ï¼šä½“é‡Ã—0.8ml/kg' : 'å† è„‰CTAå¿ƒç‡>80ï¼šä½“é‡Ã—0.85ml/kg') :
                        (results.heartRate <= 80 ? 'èƒ¸ç—›ä¸‰è”å¿ƒç‡â‰¤80ï¼šä½“é‡Ã—0.8ml/kg + 15ml' : 'èƒ¸ç—›ä¸‰è”å¿ƒç‡>80ï¼šä½“é‡Ã—0.85ml/kg + 15ml')
                    }<br>
                    <strong>æ³¨å°„æµé€Ÿï¼š</strong>${results.examType === 'coronary' ? 'ç”¨é‡Ã·12s' : '(ç”¨é‡-15ml)Ã·12s'}<br>
                    <strong>å®‰å…¨é™åˆ¶ï¼š</strong>${results.examType === 'coronary' ? 'å† è„‰CTAæœ€å¤§60ml' : 'èƒ¸ç—›ä¸‰è”æœ€å¤§75ml'}ï¼Œæµé€Ÿæœ€å¤§5.0ml/s<br>
                    <strong>è®¾å¤‡ä¾æ®ï¼š</strong>è”å½±CT960+è®¾å¤‡æŠ€æœ¯å‚æ•°<br>
                    <strong>ç¨‹åºç‰ˆæœ¬ï¼š</strong>v2.1 ä¿®æ­£ç‰ˆeGFRè®¡ç®—
                </div>
            `;
            
            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // PDFå¯¼å‡ºåŠŸèƒ½
        function exportToPDF() {
            if (!appState.currentResults) {
                showNotification('âš ï¸ æ²¡æœ‰å¯å¯¼å‡ºçš„è®¡ç®—ç»“æœ', 'warning');
                return;
            }
            
            try {
                const results = appState.currentResults;
                
                const pdfWindow = window.open('', '_blank');
                if (!pdfWindow) {
                    if (confirm('æµè§ˆå™¨é˜»æ­¢äº†å¼¹çª—ï¼Œæ˜¯å¦ä¸‹è½½æ–‡æœ¬æ ¼å¼çš„æŠ¥å‘Šï¼Ÿ')) {
                        generateTextReport();
                    } else {
                        showNotification('ğŸ’¡ è¯·å…è®¸æ­¤ç½‘ç«™çš„å¼¹çª—åŠŸèƒ½ä»¥å¯¼å‡ºPDF', 'info');
                    }
                    return;
                }
                
                const pdfContent = generatePDFContent(results);
                
                pdfWindow.document.write(pdfContent);
                pdfWindow.document.close();
                
                pdfWindow.onload = function() {
                    setTimeout(() => {
                        pdfWindow.print();
                        showNotification('ğŸ’¡ è¯·åœ¨æ‰“å°å¯¹è¯æ¡†ä¸­é€‰æ‹©"ä¿å­˜ä¸ºPDF"', 'info');
                    }, 500);
                };
                
                showNotification('âœ… PDFå¯¼å‡ºçª—å£å·²æ‰“å¼€', 'success');
                
            } catch (error) {
                console.error('PDFå¯¼å‡ºå‡ºé”™:', error);
                showNotification('âŒ PDFå¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ç”ŸæˆPDFä¼˜åŒ–çš„HTMLå†…å®¹
        function generatePDFContent(results) {
            const currentDate = new Date().toLocaleString();
            
            let bmiStatus = '';
            if (results.bmi < 18.5) bmiStatus = 'åç˜¦';
            else if (results.bmi < 24) bmiStatus = 'æ­£å¸¸';
            else if (results.bmi < 28) bmiStatus = 'è¶…é‡';
            else bmiStatus = 'è‚¥èƒ–';
            
            const examTypeText = results.examType === 'coronary' ? 'å† è„‰CTA' : 'èƒ¸ç—›ä¸‰è”';
            const heartRateText = results.heartRate <= 80 ? 'â‰¤80æ¬¡/åˆ†' : '>80æ¬¡/åˆ†';
            
            let metforminSection = '';
            if (results.metforminRisk) {
                const risk = results.metforminRisk;
                metforminSection = `
                    <div class="section compact-section">
                        <h3>äºŒç”²åŒèƒé£é™©è¯„ä¼°</h3>
                        <table class="data-table">
                            <tr><td>è¡€è‚Œé…å€¼</td><td>${risk.creatinine} Î¼mol/L</td></tr>
                            <tr><td>eGFR</td><td>${risk.eGFR} ml/min/1.73mÂ²</td></tr>
                            <tr><td>é£é™©ç­‰çº§</td><td>${risk.clinicalAction}</td></tr>
                            <tr><td>é£é™©è¯„åˆ†</td><td>${risk.riskScore.toFixed(1)} åˆ†</td></tr>
                        </table>
                        <div class="recommendations">
                            <h4>å¤„ç†å»ºè®®ï¼š</h4>
                            <ul>${risk.recommendations.slice(0,3).map(rec => `<li>${rec}</li>`).join('')}</ul>
                        </div>
                    </div>
                `;
            } else if (results.metforminStatus === 'unknown') {
                metforminSection = `
                    <div class="section compact-section">
                        <h3>äºŒç”²åŒèƒé£é™©è¯„ä¼°</h3>
                        <div class="warning-box">
                            <strong>âš ï¸ ç”¨è¯å²ä¸æ˜ç¡®</strong><br>
                            å»ºè®®è¯¦ç»†è¯¢é—®ç”¨è¯å²ï¼Œå¦‚æ— æ³•ç¡®è®¤æŒ‰æœç”¨å¤„ç†ã€‚
                        </div>
                    </div>
                `;
            } else {
                metforminSection = `
                    <div class="section compact-section">
                        <h3>äºŒç”²åŒèƒé£é™©è¯„ä¼°</h3>
                        <div class="success-box">
                            <strong>âœ… æ— ç›¸å…³é£é™©</strong><br>
                            æœªæœç”¨äºŒç”²åŒèƒï¼ŒæŒ‰æ ‡å‡†æµç¨‹æ£€æŸ¥ã€‚
                        </div>
                    </div>
                `;
            }
            
            let warningSection = '';
            if (results.isVolumeExceeded || results.isFlowRateExceeded || results.contrastAdjustment) {
                let warnings = [];
                
                if (results.isVolumeExceeded) {
                    warnings.push(`é€ å½±å‰‚ç”¨é‡é™åˆ¶ï¼šç†è®ºè®¡ç®—${results.originalVolume.toFixed(1)}ml â†’ å®‰å…¨é™åˆ¶${results.contrastVolume.toFixed(1)}ml`);
                }
                
                if (results.isFlowRateExceeded) {
                    warnings.push(`æ³¨å°„æµé€Ÿé™åˆ¶ï¼šç†è®ºè®¡ç®—${results.originalFlowRate.toFixed(2)}ml/s â†’ å®‰å…¨é™åˆ¶${results.flowRate.toFixed(2)}ml/s`);
                }
                
                if (results.contrastAdjustment) {
                    warnings.push(`è‚¾åŠŸèƒ½è°ƒæ•´ï¼š${results.contrastAdjustment}`);
                }
                
                warningSection = `
                    <div class="section compact-section">
                        <h3>å®‰å…¨æç¤º</h3>
                        <div class="warning-box">
                            ${warnings.map(w => `<div>â€¢ ${w.length > 40 ? w.substring(0, 40) + '...' : w}</div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—æŠ¥å‘Š v2.1</title>
    <style>
        @page { size: A4; margin: 1.5cm; }
        body { font-family: 'Microsoft YaHei', 'SimSun', sans-serif; line-height: 1.4; color: #333; max-width: 800px; margin: 0 auto; padding: 10px; font-size: 13px; }
        .header { text-align: center; border-bottom: 2px solid #4f46e5; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { color: #4f46e5; font-size: 22px; margin-bottom: 8px; }
        .header .subtitle { color: #666; font-size: 13px; margin-bottom: 5px; }
        .header .time-info { font-size: 11px; color: #888; }
        .section { margin-bottom: 18px; page-break-inside: avoid; }
        .section h3 { color: #4f46e5; font-size: 16px; border-left: 3px solid #4f46e5; padding-left: 10px; margin-bottom: 10px; }
        .section h4 { color: #333; font-size: 14px; margin: 10px 0 8px 0; }
        .data-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .data-table td { padding: 8px 12px; border-bottom: 1px solid #e0e0e0; font-size: 12px; }
        .data-table td:first-child { font-weight: 600; background-color: #f8f9fa; width: 35%; }
        .data-table td:last-child { color: #4f46e5; font-weight: 600; }
        .calc-info { background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #4f46e5; font-size: 11px; line-height: 1.5; }
        .recommendations ul, .warning-box ul, .success-box ul { margin: 8px 0; padding-left: 18px; }
        .recommendations li, .warning-box li, .success-box li { margin-bottom: 3px; font-size: 11px; }
        .warning-box { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; font-size: 11px; }
        .success-box { background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 4px; padding: 10px; font-size: 11px; }
        .footer { margin-top: 20px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #e0e0e0; padding-top: 12px; line-height: 1.4; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .compact-section { margin-bottom: 12px; }
        @media print { body { margin: 0; padding: 0; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—ç»“æœ</h1>
        <div class="subtitle">CTAé€ å½±å‰‚ç”¨é‡ä¸BMIå­¦æœ¯å‚è€ƒè®¡ç®—ï¼ˆå«äºŒç”²åŒèƒè¯„ä¼°ï¼‰v2.1</div>
        <div class="time-info">
            è®¡ç®—æ—¶é—´ï¼š${results.timestamp.toLocaleString()} | ç»“æœç”Ÿæˆæ—¶é—´ï¼š${currentDate}
        </div>
    </div>
    
    <div class="two-column">
        <div>
            <div class="section compact-section">
                <h3>æ‚£è€…åŸºæœ¬ä¿¡æ¯</h3>
                <table class="data-table">
                    <tr><td>èº«é«˜</td><td>${results.height} cm</td></tr>
                    <tr><td>ä½“é‡</td><td>${results.weight} kg</td></tr>
                    <tr><td>BMIæŒ‡æ•°</td><td>${results.bmi.toFixed(2)} (${bmiStatus})</td></tr>
                </table>
            </div>
            
            <div class="section compact-section">
                <h3>æ£€æŸ¥å‚æ•°</h3>
                <table class="data-table">
                    <tr><td>æ£€æŸ¥ç±»å‹</td><td>${examTypeText}</td></tr>
                    <tr><td>å¿ƒç‡å‚æ•°</td><td>${heartRateText}</td></tr>
                    <tr><td>äºŒç”²åŒèƒçŠ¶æ€</td><td>${results.metforminStatus === 'yes' ? 'æ˜¯ï¼Œæœ‰æœç”¨' : results.metforminStatus === 'no' ? 'å¦ï¼Œæœªæœç”¨' : 'ä¸ç¡®å®š'}</td></tr>
                </table>
            </div>
            
            <div class="section compact-section">
                <h3>è®¡ç®—ç»“æœ</h3>
                <table class="data-table">
                    <tr><td>é€ å½±å‰‚ç”¨é‡</td><td>${results.contrastVolume.toFixed(1)} ml</td></tr>
                    <tr><td>æ³¨å°„æµé€Ÿ</td><td>${results.flowRate.toFixed(2)} ml/s</td></tr>
                </table>
            </div>
        </div>
        
        <div>
            ${metforminSection}
            ${warningSection}
        </div>
    </div>
    
    <div class="section">
        <h3>è®¡ç®—ä¾æ®</h3>
        <div class="calc-info">
            <strong>eGFRå…¬å¼ï¼š</strong>2021ç‰ˆCKD-EPIæ–¹ç¨‹ï¼ˆæ— ç§æ—ç³»æ•°ï¼‰<br>
            <strong>é€ å½±å‰‚ç”¨é‡ï¼š</strong>${results.examType === 'coronary' ? 
                (results.heartRate <= 80 ? 'å† è„‰CTAï¼šä½“é‡Ã—0.8ml/kg' : 'å† è„‰CTAï¼šä½“é‡Ã—0.85ml/kg') :
                (results.heartRate <= 80 ? 'èƒ¸ç—›ä¸‰è”ï¼šä½“é‡Ã—0.8ml/kg+15ml' : 'èƒ¸ç—›ä¸‰è”ï¼šä½“é‡Ã—0.85ml/kg+15ml')
            }<br>
            <strong>æ³¨å°„æµé€Ÿï¼š</strong>${results.examType === 'coronary' ? 'ç”¨é‡Ã·12s' : '(ç”¨é‡-15ml)Ã·12s'} | 
            <strong>å®‰å…¨é™åˆ¶ï¼š</strong>${results.examType === 'coronary' ? 'æœ€å¤§60ml' : 'æœ€å¤§75ml'}ï¼Œæµé€Ÿâ‰¤5.0ml/s
        </div>
    </div>
    
    <div class="footer">
        <p><strong>é‡è¦å£°æ˜ï¼š</strong>æœ¬ç»“æœä»…ä¾›å­¦æœ¯ç ”ç©¶å‚è€ƒï¼Œä¸¥ç¦ç”¨äºä¸´åºŠè¯Šæ–­æˆ–æ²»ç–—å†³ç­–</p>
        <p>å·¥å…·ç‰ˆæœ¬ï¼šv2.1 | å¼€å‘è€…ï¼šå½±åƒæ¶›å“¥ | ç»“æœç¼–å·ï¼š${Date.now()}</p>
    </div>
</body>
</html>`;
        }

        // ç”Ÿæˆæ–‡æœ¬æ ¼å¼æŠ¥å‘Š
        function generateTextReport() {
            if (!appState.currentResults) return;
            
            const results = appState.currentResults;
            let bmiStatus = '';
            if (results.bmi < 18.5) bmiStatus = 'åç˜¦';
            else if (results.bmi < 24) bmiStatus = 'æ­£å¸¸';
            else if (results.bmi < 28) bmiStatus = 'è¶…é‡';
            else bmiStatus = 'è‚¥èƒ–';
            
            const examTypeText = results.examType === 'coronary' ? 'å† è„‰CTA' : 'èƒ¸ç—›ä¸‰è”';
            const heartRateText = results.heartRate <= 80 ? 'â‰¤80æ¬¡/åˆ†' : '>80æ¬¡/åˆ†';
            
            let metforminSection = '';
            if (results.metforminRisk) {
                const risk = results.metforminRisk;
                metforminSection = `
äºŒç”²åŒèƒé£é™©è¯„ä¼°
--------------
è¡€è‚Œé…å€¼ï¼š${risk.creatinine} Î¼mol/L
eGFR (2021ç‰ˆCKD-EPI)ï¼š${risk.eGFR} ml/min/1.73mÂ²
è®¡ç®—æ–¹æ³•ï¼š${risk.calculationMethod}
é£é™©ç­‰çº§ï¼š${risk.clinicalAction}
é£é™©è¯„åˆ†ï¼š${risk.riskScore.toFixed(1)} åˆ†

ä¸´åºŠå»ºè®®ï¼š
${risk.recommendations.map(rec => `â€¢ ${rec}`).join('\n')}
`;
            } else if (results.metforminStatus === 'unknown') {
                metforminSection = `
äºŒç”²åŒèƒé£é™©è¯„ä¼°
--------------
âš ï¸ ç”¨è¯å²ä¸æ˜ç¡®è­¦å‘Š
â€¢ å¼ºçƒˆå»ºè®®è¯¦ç»†è¯¢é—®æ‚£è€…ç”¨è¯å²
â€¢ å¦‚æ— æ³•ç¡®è®¤ï¼Œå»ºè®®é€ å½±å‰48-72å°æ—¶åœç”¨æ‰€æœ‰é™ç³–è¯
â€¢ å¿…è¦æ—¶å†…åˆ†æ³Œç§‘ä¼šè¯Š
`;
            } else {
                metforminSection = `
äºŒç”²åŒèƒé£é™©è¯„ä¼°
--------------
âœ… æ— äºŒç”²åŒèƒç›¸å…³é£é™©
æ‚£è€…æœªæœç”¨äºŒç”²åŒèƒï¼Œå¯æŒ‰æ ‡å‡†æµç¨‹è¿›è¡Œé€ å½±æ£€æŸ¥ã€‚
`;
            }
            
            const reportText = `å½±åƒå­¦æœ¯ç ”ç©¶è®¡ç®—ç»“æœ v2.1
==============================

è®¡ç®—æ—¶é—´ï¼š${results.timestamp.toLocaleString()}
ç»“æœç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}

æ‚£è€…åŸºæœ¬ä¿¡æ¯
-----------
èº«é«˜ï¼š${results.height} cm
ä½“é‡ï¼š${results.weight} kg
BMIï¼š${results.bmi.toFixed(2)} (${bmiStatus})

æ£€æŸ¥å‚æ•°
--------
æ£€æŸ¥ç±»å‹ï¼š${examTypeText}
å¿ƒç‡å‚æ•°ï¼š${heartRateText}
äºŒç”²åŒèƒçŠ¶æ€ï¼š${results.metforminStatus === 'yes' ? 'æ˜¯ï¼Œæœ‰æœç”¨' : results.metforminStatus === 'no' ? 'å¦ï¼Œæœªæœç”¨' : 'ä¸ç¡®å®š'}

è®¡ç®—ç»“æœ
--------
é€ å½±å‰‚ç”¨é‡ï¼š${results.contrastVolume.toFixed(1)} ml
æ³¨å°„æµé€Ÿï¼š${results.flowRate.toFixed(2)} ml/s

${metforminSection}

è®¡ç®—ä¾æ®
--------
eGFRå…¬å¼ï¼š2021ç‰ˆCKD-EPIè‚¾å°çƒæ»¤è¿‡ç‡æ–¹ç¨‹ï¼ˆæ— ç§æ—ç³»æ•°ï¼Œç›´æ¥ä½¿ç”¨Î¼mol/Lï¼‰
é€ å½±å‰‚ç”¨é‡ï¼š${results.examType === 'coronary' ? 
    (results.heartRate <= 80 ? 'å† è„‰CTAå¿ƒç‡â‰¤80ï¼šä½“é‡Ã—0.8ml/kg' : 'å† è„‰CTAå¿ƒç‡>80ï¼šä½“é‡Ã—0.85ml/kg') :
    (results.heartRate <= 80 ? 'èƒ¸ç—›ä¸‰è”å¿ƒç‡â‰¤80ï¼šä½“é‡Ã—0.8ml/kg + 15ml' : 'èƒ¸ç—›ä¸‰è”å¿ƒç‡>80ï¼šä½“é‡Ã—0.85ml/kg + 15ml')
}
æ³¨å°„æµé€Ÿï¼š${results.examType === 'coronary' ? 'ç”¨é‡Ã·12s' : '(ç”¨é‡-15ml)Ã·12s'}
å®‰å…¨é™åˆ¶ï¼š${results.examType === 'coronary' ? 'å† è„‰CTAæœ€å¤§60ml' : 'èƒ¸ç—›ä¸‰è”æœ€å¤§75ml'}ï¼Œæµé€Ÿæœ€å¤§5.0ml/s
è®¾å¤‡ä¾æ®ï¼šè”å½±CT960+è®¾å¤‡æŠ€æœ¯å‚æ•°
ç¨‹åºç‰ˆæœ¬ï¼šv2.1 ä¿®æ­£ç‰ˆeGFRè®¡ç®—

é‡è¦å£°æ˜
--------
æœ¬ç»“æœä»…ä¾›å­¦æœ¯ç ”ç©¶å‚è€ƒï¼Œä¸¥ç¦ç”¨äºä¸´åºŠè¯Šæ–­æˆ–æ²»ç–—å†³ç­–
å·¥å…·ç‰ˆæœ¬ï¼šv2.1 | å¼€å‘è€…ï¼šå½±åƒæ¶›å“¥
eGFRè®¡ç®—ï¼šé‡‡ç”¨2021ç‰ˆCKD-EPIå…¬å¼ï¼Œç›´æ¥ä½¿ç”¨Î¼mol/Lå•ä½è®¡ç®—
ç»“æœç¼–å·ï¼š${Date.now()}`;
            
            const dataBlob = new Blob([reportText], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å½±åƒè®¡ç®—ç»“æœ_v2.1_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
            
            link.addEventListener('click', function() {
                setTimeout(() => URL.revokeObjectURL(url), 100);
            });
            
            link.click();
            showNotification('âœ… æ–‡æœ¬æ ¼å¼ç»“æœå·²ä¸‹è½½', 'success');
        }

        // é€šçŸ¥æ˜¾ç¤ºå‡½æ•°
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 20px;
                border-radius: 8px; color: white; font-weight: 500; z-index: 1000;
                opacity: 0; transition: opacity 0.3s ease; max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            switch(type) {
                case 'success': notification.style.background = '#22c55e'; break;
                case 'error': notification.style.background = '#ef4444'; break;
                case 'warning': notification.style.background = '#f59e0b'; break;
                default: notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                setupRealTimeValidation();
                handleMetforminChange();
                
                document.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !document.getElementById('calculateBtn').disabled) {
                        calculate();
                    }
                });
                
                updateProgress();
                
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å‡ºé”™:', error);
                alert('âš ï¸ é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨');
            }
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            showNotification('âŒ ç¨‹åºè¿è¡Œå‡ºç°å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            showNotification('âš ï¸ å¼‚æ­¥æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'warning');
        });
    </script>
</body>
</html>
