<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影像学术研究计算工具 v2.1</title>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #ffffff;
            --text: #1e293b;
            --card: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #f87171;
            --bg: #0f172a;
            --text: #e2e8f0;
            --card: #1e293b;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            color: var(--text);
            opacity: 0.7;
            margin-bottom: 20px;
        }

        .form-section {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 1.3em;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required {
            color: var(--error);
        }

        input, select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .input-hint {
            font-size: 12px;
            color: var(--text);
            opacity: 0.6;
            margin-top: 4px;
        }

        .input-error {
            border-color: var(--error) !important;
            background-color: rgba(239, 68, 68, 0.05);
        }

        .error-message {
            color: var(--error);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .metformin-section {
            border: 2px solid var(--warning);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.1));
        }

        .metformin-warning, .metformin-alert, .normal-info, .limit-warning {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .metformin-warning {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .metformin-alert {
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b;
            border-left: 4px solid var(--error);
        }

        .normal-info {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .limit-warning {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .results {
            background: var(--card);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--border);
            margin-top: 25px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .results.show { display: block; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            background: var(--bg);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .result-label {
            font-weight: 500;
            color: var(--text);
        }

        .result-value {
            font-size: 1.2em;
            color: var(--primary);
            font-weight: 700;
        }

        .calc-type {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fef7cd, #fed7aa);
            color: #92400e;
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid var(--warning);
            margin-top: 25px;
            font-size: 13px;
            line-height: 1.6;
        }

        .disclaimer h3 {
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 700;
        }

        .highlight {
            font-weight: 700;
            color: #b45309;
        }

        .real-time-validation {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }

        .validation-success { color: var(--success); }
        .validation-error { color: var(--error); }

        .formula-display {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text);
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            h1 { font-size: 2em; }
            .form-row { grid-template-columns: 1fr; gap: 15px; }
            .theme-toggle { position: relative; margin-bottom: 20px; }
            .btn-group { flex-direction: column; }
        }

        @media print {
            body { background: white; color: black; }
            .container { background: white; box-shadow: none; }
            .btn, .theme-toggle { display: none; }
            .no-print { display: none; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">🌙</span>
                <span id="theme-text">夜间模式</span>
            </div>
            <h1>影像学术研究计算工具</h1>
            <div class="subtitle">CTA造影剂用量与BMI学术参考计算（含二甲双胍评估）v2.1</div>
            <div style="margin-top: 15px; padding: 8px 16px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 20px; font-size: 14px; font-weight: 600; display: inline-block;">
                💻 程序开发者：影像涛哥
            </div>
        </div>
        
        <div class="form-section">
            <h2 class="section-title">
                <span>⚙️</span>
                基础参数设置
            </h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="height">身高 (cm) <span class="required">*</span></label>
                    <input type="number" id="height" placeholder="请输入身高，如：170" min="100" max="250" step="0.1" required>
                    <span class="real-time-validation" id="height-validation"></span>
                    <div class="input-hint">范围：100-250cm</div>
                    <div class="error-message" id="height-error">身高必须在100-250cm之间</div>
                </div>
                <div class="form-group">
                    <label for="weight">体重 (kg) <span class="required">*</span></label>
                    <input type="number" id="weight" placeholder="请输入体重，如：70" min="20" max="200" step="0.1" required>
                    <span class="real-time-validation" id="weight-validation"></span>
                    <div class="input-hint">范围：20-200kg</div>
                    <div class="error-message" id="weight-error">体重必须在20-200kg之间</div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="heartRate">心率参数</label>
                    <select id="heartRate">
                        <option value="80">≤80 次/分</option>
                        <option value="81">>80 次/分</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="examType">检查类型</label>
                    <select id="examType">
                        <option value="coronary">冠脉CTA</option>
                        <option value="triple">胸痛三联</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-section metformin-section" id="metforminSection">
            <h2 class="section-title">
                <span>💊</span>
                二甲双胍用药评估（2021版CKD-EPI）
            </h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="metforminStatus">48小时内是否服用二甲双胍？</label>
                    <select id="metforminStatus" onchange="handleMetforminChange()">
                        <option value="no">否，未服用</option>
                        <option value="yes">是，有服用</option>
                        <option value="unknown">不确定</option>
                    </select>
                </div>
                <div class="form-group" id="metforminDoseGroup" style="display: none;">
                    <label for="metforminDose">二甲双胍剂量（mg/日）</label>
                    <select id="metforminDose">
                        <option value="500">500mg/日</option>
                        <option value="850">850mg/日</option>
                        <option value="1000">1000mg/日</option>
                        <option value="1500">1500mg/日</option>
                        <option value="2000">2000mg/日</option>
                        <option value="other">其他剂量</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row" id="renalFunctionGroup" style="display: none;">
                <div class="form-group">
                    <label for="creatinine">血肌酐值 (μmol/L) <span class="required">*</span></label>
                    <input type="number" id="creatinine" placeholder="请输入血肌酐值，如：80" min="30" max="500" step="1">
                    <span class="real-time-validation" id="creatinine-validation"></span>
                    <div class="input-hint">范围：30-500 μmol/L，用于评估肾功能</div>
                    <div class="error-message" id="creatinine-error">血肌酐值必须在30-500 μmol/L之间</div>
                    <div class="formula-display" id="formulaDisplay" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="age">年龄 (岁) <span class="required">*</span></label>
                    <input type="number" id="age" placeholder="请输入年龄，如：45" min="18" max="120" step="1">
                    <span class="real-time-validation" id="age-validation"></span>
                    <div class="input-hint">范围：18-120岁</div>
                    <div class="error-message" id="age-error">年龄必须在18-120岁之间</div>
                </div>
            </div>

            <div class="form-row" id="genderGroup" style="display: none;">
                <div class="form-group">
                    <label for="gender">性别 <span class="required">*</span></label>
                    <select id="gender" onchange="updateFormulaDisplay()">
                        <option value="male">男性</option>
                        <option value="female">女性</option>
                    </select>
                </div>
            </div>

            <div id="metforminInfo">
                <div class="normal-info">
                    <strong>✅ 无二甲双胍用药风险：</strong><br>
                    患者未服用二甲双胍，无需考虑二甲双胍-造影剂相互作用风险。
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="calculate()" id="calculateBtn">
                    <span>🧮</span> 计算参考数值
                </button>
                <button class="btn btn-secondary" onclick="exportToPDF()" id="pdfBtn" disabled>
                    <span>📑</span> 导出PDF
                </button>
            </div>
        </div>

        <div class="results" id="results">
            <h2 class="section-title">
                <span>📊</span>
                计算结果
            </h2>
            <div id="calculationResults"></div>
        </div>

        <div class="disclaimer">
            <h3>⚠️ 重要使用声明</h3>
            <p><span class="highlight">专业背景要求：</span>使用者须是在医学影像科工作的专业人员，熟悉CT检查流程和造影剂使用规范。</p>
            <p><span class="highlight">设备依据：</span>本工具计算公式基于联影CT960+设备的技术参数和临床研究数据。</p>
            <p><span class="highlight">学术用途：</span>仅供影像技术教学、学术研究使用，严禁用于临床诊断或治疗决策。</p>
            <p><span class="highlight">二甲双胍评估：</span>集成的二甲双胍-造影剂相互作用评估仅供参考，临床决策需结合完整病史和实验室检查。</p>
            <p><span class="highlight">eGFR计算：</span>采用2021版CKD-EPI公式（无种族系数），适用于中国人群，计算方式已优化修正。</p>
            <p><span class="highlight">安全限制：</span>程序已设置造影剂用量和注射流速的安全上限，但实际使用需结合患者具体情况充分评估血管通路和肾功能。</p>
            <p style="margin-top: 15px; font-weight: 700; color: #b45309; border-top: 1px solid #fed7aa; padding-top: 15px;">
                开发者不承担任何直接或间接的法律责任！使用即表示同意本声明。
            </p>
        </div>
    </div>

    <script>
        // 全局状态管理
        const appState = {
            isDarkMode: false,
            currentResults: null
        };

        // 主题切换功能
        function toggleTheme() {
            try {
                appState.isDarkMode = !appState.isDarkMode;
                const body = document.body;
                const themeIcon = document.getElementById('theme-icon');
                const themeText = document.getElementById('theme-text');
                
                if (appState.isDarkMode) {
                    body.setAttribute('data-theme', 'dark');
                    if (themeIcon) themeIcon.textContent = '☀️';
                    if (themeText) themeText.textContent = '日间模式';
                } else {
                    body.removeAttribute('data-theme');
                    if (themeIcon) themeIcon.textContent = '🌙';
                    if (themeText) themeText.textContent = '夜间模式';
                }
            } catch (error) {
                console.error('主题切换出错:', error);
                showNotification('⚠️ 主题切换失败', 'warning');
            }
        }

        // 修正版2021年CKD-EPI eGFR计算函数（直接使用μmol/L）
        function calculateEGFR_2021_Corrected(creatinine_umol, age, gender) {
            let eGFR;
            
            if (gender === 'female') {
                // 女性阈值：62 μmol/L (相当于0.7 mg/dL)
                if (creatinine_umol <= 62) {
                    // Scr ≤ 62 μmol/L: 使用 -0.241 指数
                    eGFR = 142 * Math.pow(creatinine_umol / 62, -0.241) * Math.pow(0.9938, age) * 1.012;
                } else {
                    // Scr > 62 μmol/L: 使用 -1.2 指数
                    eGFR = 142 * Math.pow(62 / creatinine_umol, 1.2) * Math.pow(0.9938, age) * 1.012;
                }
            } else {
                // 男性阈值：80 μmol/L (相当于0.9 mg/dL)
                if (creatinine_umol <= 80) {
                    // Scr ≤ 80 μmol/L: 使用 -0.302 指数
                    eGFR = 142 * Math.pow(creatinine_umol / 80, -0.302) * Math.pow(0.9938, age);
                } else {
                    // Scr > 80 μmol/L: 使用 -1.2 指数
                    eGFR = 142 * Math.pow(80 / creatinine_umol, 1.2) * Math.pow(0.9938, age);
                }
            }
            
            return Math.round(eGFR);
        }

        // 更新公式显示
        function updateFormulaDisplay() {
            const gender = document.getElementById('gender').value;
            const creatinine = parseFloat(document.getElementById('creatinine').value);
            const formulaDisplay = document.getElementById('formulaDisplay');
            
            if (!creatinine || creatinine < 30 || creatinine > 500) {
                formulaDisplay.style.display = 'none';
                return;
            }
            
            let formulaText = '';
            let threshold = '';
            let currentFormula = '';
            
            if (gender === 'female') {
                threshold = '62 μmol/L';
                if (creatinine <= 62) {
                    currentFormula = `eGFR = 142 × (${creatinine}/62)^(-0.241) × 0.9938^年龄 × 1.012`;
                    formulaText = `女性，Scr ≤ ${threshold}，使用公式：<br>${currentFormula}`;
                } else {
                    currentFormula = `eGFR = 142 × (62/${creatinine})^1.2 × 0.9938^年龄 × 1.012`;
                    formulaText = `女性，Scr > ${threshold}，使用公式：<br>${currentFormula}`;
                }
            } else {
                threshold = '80 μmol/L';
                if (creatinine <= 80) {
                    currentFormula = `eGFR = 142 × (${creatinine}/80)^(-0.302) × 0.9938^年龄`;
                    formulaText = `男性，Scr ≤ ${threshold}，使用公式：<br>${currentFormula}`;
                } else {
                    currentFormula = `eGFR = 142 × (80/${creatinine})^1.2 × 0.9938^年龄`;
                    formulaText = `男性，Scr > ${threshold}，使用公式：<br>${currentFormula}`;
                }
            }
            
            formulaDisplay.innerHTML = formulaText;
            formulaDisplay.style.display = 'block';
        }

        // 实时输入验证
        function setupRealTimeValidation() {
            try {
                const validationRules = {
                    height: { min: 100, max: 250, message: '身高必须在100-250cm之间' },
                    weight: { min: 20, max: 200, message: '体重必须在20-200kg之间' },
                    creatinine: { min: 30, max: 500, message: '血肌酐值必须在30-500μmol/L之间' },
                    age: { min: 18, max: 120, message: '年龄必须在18-120岁之间' }
                };

                Object.keys(validationRules).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const validation = document.getElementById(`${fieldId}-validation`);
                    const error = document.getElementById(`${fieldId}-error`);
                    
                    if (field) {
                        field.addEventListener('input', function() {
                            try {
                                validateField(this, validationRules[fieldId], validation, error);
                                updateProgress();
                                
                                // 如果是肌酐值变化，更新公式显示
                                if (fieldId === 'creatinine') {
                                    updateFormulaDisplay();
                                }
                            } catch (error) {
                                console.error(`验证字段${fieldId}时出错:`, error);
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('设置实时验证时出错:', error);
                showNotification('⚠️ 输入验证功能异常', 'warning');
            }
        }

        function validateField(field, rule, validationEl, errorEl) {
            try {
                const value = parseFloat(field.value);
                const isValid = !isNaN(value) && value >= rule.min && value <= rule.max;
                
                if (field.value === '') {
                    field.classList.remove('input-error');
                    if (validationEl) validationEl.textContent = '';
                    if (errorEl) errorEl.style.display = 'none';
                    return null;
                }
                
                if (isValid) {
                    field.classList.remove('input-error');
                    if (validationEl) {
                        validationEl.textContent = '✓';
                        validationEl.className = 'real-time-validation validation-success';
                    }
                    if (errorEl) errorEl.style.display = 'none';
                    return true;
                } else {
                    field.classList.add('input-error');
                    if (validationEl) {
                        validationEl.textContent = '✗';
                        validationEl.className = 'real-time-validation validation-error';
                    }
                    if (errorEl) errorEl.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error('字段验证出错:', error);
                return false;
            }
        }

        function updateProgress() {
            try {
                const requiredFields = ['height', 'weight'];
                const metforminStatus = document.getElementById('metforminStatus').value;
                
                if (metforminStatus === 'yes') {
                    requiredFields.push('creatinine', 'age');
                }
                
                let completedFields = 0;
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field.value !== '') {
                        completedFields++;
                    }
                });
                
                const progress = (completedFields / requiredFields.length) * 100;
                const progressBar = document.getElementById('progress');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                
                const calculateBtn = document.getElementById('calculateBtn');
                if (calculateBtn) {
                    calculateBtn.disabled = progress < 100;
                }
            } catch (error) {
                console.error('更新进度条出错:', error);
            }
        }

        // 增强的二甲双胍风险评估
        function assessMetforminRisk(eGFR, dose, age) {
            let riskLevel = 'low';
            let recommendations = [];
            let clinicalAction = '';
            
            if (eGFR >= 60) {
                riskLevel = 'low';
                clinicalAction = '标准处理';
                recommendations = [
                    '肾功能正常，造影前后暂停二甲双胍48小时',
                    '造影后监测肾功能，无异常可恢复用药',
                    '建议造影前后充分水化'
                ];
            } else if (eGFR >= 45) {
                riskLevel = 'moderate';
                clinicalAction = '谨慎监测';
                recommendations = [
                    '轻度肾功能不全，需谨慎评估',
                    '造影前后暂停二甲双胍48-72小时',
                    '造影后48-72小时复查肾功能',
                    '建议静脉水化：0.9% NaCl 1ml/kg/h，检查前6-12h开始'
                ];
            } else if (eGFR >= 30) {
                riskLevel = 'high';
                clinicalAction = '高风险处理';
                recommendations = [
                    '中度肾功能不全，高风险',
                    '造影前后暂停二甲双胍72小时',
                    '考虑减少造影剂用量至标准用量的80%',
                    '必须静脉水化：0.9% NaCl 1ml/kg/h × 12h',
                    '使用等渗造影剂（碘克沙醇）',
                    '造影后72小时内密切监测肾功能'
                ];
            } else {
                riskLevel = 'very-high';
                clinicalAction = '极高风险 - 避免检查';
                recommendations = [
                    '重度肾功能不全，极高风险',
                    '强烈建议避免使用造影剂',
                    '如必须检查，需内分泌科和肾内科会诊',
                    '考虑替代检查方法（MRI、超声等）',
                    '如无法避免，需透析准备'
                ];
            }

            // 年龄因素调整
            if (age >= 75 && eGFR < 60) {
                recommendations.unshift('高龄患者，增加监测频次');
            }
            
            return { 
                riskLevel, 
                recommendations, 
                clinicalAction,
                riskScore: calculateRiskScore(eGFR, age, dose)
            };
        }

        function calculateRiskScore(eGFR, age, dose) {
            let score = 0;
            
            // eGFR评分
            if (eGFR >= 60) score += 1;
            else if (eGFR >= 45) score += 2;
            else if (eGFR >= 30) score += 3;
            else score += 4;
            
            // 年龄评分
            if (age >= 75) score += 1;
            else if (age >= 65) score += 0.5;
            
            // 剂量评分
            const doseNum = parseInt(dose);
            if (doseNum >= 2000) score += 1;
            else if (doseNum >= 1500) score += 0.5;
            
            return score;
        }

        // 二甲双胍状态变化处理
        function handleMetforminChange() {
            try {
                const metforminStatus = document.getElementById('metforminStatus').value;
                const metforminDoseGroup = document.getElementById('metforminDoseGroup');
                const renalFunctionGroup = document.getElementById('renalFunctionGroup');
                const genderGroup = document.getElementById('genderGroup');
                const metforminInfo = document.getElementById('metforminInfo');

                if (metforminStatus === 'yes') {
                    metforminDoseGroup.style.display = 'block';
                    renalFunctionGroup.style.display = 'block';
                    genderGroup.style.display = 'block';
                    
                    metforminInfo.innerHTML = `
                        <div class="metformin-warning">
                            <strong>⚠️ 二甲双胍用药提醒：</strong><br>
                            • 造影剂可能影响肾功能，增加乳酸酸中毒风险<br>
                            • 建议造影检查前后48-72小时暂停二甲双胍<br>
                            • 需评估患者肾功能(eGFR)决定是否继续用药<br>
                            • 请输入相关参数以进行精确风险评估（使用2021 CKD-EPI公式）
                        </div>
                    `;
                } else if (metforminStatus === 'unknown') {
                    metforminDoseGroup.style.display = 'none';
                    renalFunctionGroup.style.display = 'none';
                    genderGroup.style.display = 'none';
                    
                    metforminInfo.innerHTML = `
                        <div class="metformin-alert">
                            <strong>🚨 用药史不明确警告：</strong><br>
                            • 强烈建议详细询问患者用药史<br>
                            • 糖尿病患者常规使用二甲双胍<br>
                            • 如无法确认，建议按服用二甲双胍处理<br>
                            • 造影前应暂停二甲双胍48-72小时
                        </div>
                    `;
                } else {
                    metforminDoseGroup.style.display = 'none';
                    renalFunctionGroup.style.display = 'none';
                    genderGroup.style.display = 'none';
                    
                    metforminInfo.innerHTML = `
                        <div class="normal-info">
                            <strong>✅ 无二甲双胍用药风险：</strong><br>
                            患者未服用二甲双胍，无需考虑二甲双胍-造影剂相互作用风险。
                        </div>
                    `;
                }
                
                updateProgress();
                
                // 重置公式显示
                const formulaDisplay = document.getElementById('formulaDisplay');
                if (formulaDisplay) {
                    formulaDisplay.style.display = 'none';
                }
                
            } catch (error) {
                console.error('二甲双胍状态更新出错:', error);
                showNotification('⚠️ 界面更新失败，请刷新页面', 'warning');
            }
        }

        // 主计算函数
        function calculate() {
            try {
                const height = parseFloat(document.getElementById('height').value);
                const weight = parseFloat(document.getElementById('weight').value);
                const heartRate = parseInt(document.getElementById('heartRate').value);
                const examType = document.getElementById('examType').value;
                const metforminStatus = document.getElementById('metforminStatus').value;

                // 综合输入验证
                const validationErrors = [];
                
                if (!height || height < 100 || height > 250) {
                    validationErrors.push('身高范围应在100-250cm之间');
                }
                if (!weight || weight < 20 || weight > 200) {
                    validationErrors.push('体重范围应在20-200kg之间');
                }

                // 二甲双胍相关验证
                let metforminRisk = null;
                if (metforminStatus === 'yes') {
                    const creatinine = parseFloat(document.getElementById('creatinine').value);
                    const age = parseInt(document.getElementById('age').value);
                    const gender = document.getElementById('gender').value;
                    const dose = document.getElementById('metforminDose').value;

                    if (!creatinine || creatinine < 30 || creatinine > 500) {
                        validationErrors.push('血肌酐值范围应在30-500 μmol/L之间');
                    }
                    if (!age || age < 18 || age > 120) {
                        validationErrors.push('年龄范围应在18-120岁之间');
                    }

                    if (validationErrors.length === 0) {
                        // 使用修正版eGFR计算
                        const eGFR = calculateEGFR_2021_Corrected(creatinine, age, gender);
                        metforminRisk = assessMetforminRisk(eGFR, dose, age);
                        metforminRisk.eGFR = eGFR;
                        metforminRisk.creatinine = creatinine;
                        metforminRisk.age = age;
                        metforminRisk.gender = gender;
                        metforminRisk.dose = dose;
                        metforminRisk.calculationMethod = '2021版CKD-EPI（直接计算）';
                    }
                }

                if (validationErrors.length > 0) {
                    showNotification('❌ 输入验证失败：\n' + validationErrors.join('\n'), 'error');
                    return;
                }

                // 执行计算
                const results = performCalculations(height, weight, heartRate, examType, metforminStatus, metforminRisk);
                displayResults(results);
                
                // 保存到状态
                appState.currentResults = results;

                // 启用PDF导出按钮
                document.getElementById('pdfBtn').disabled = false;
                
                // 显示成功提示
                showNotification('✅ 计算完成！使用修正版eGFR公式', 'success');
                
            } catch (error) {
                console.error('计算过程出错:', error);
                showNotification('❌ 计算过程中出现错误，请检查输入数据', 'error');
            }
        }

        function performCalculations(height, weight, heartRate, examType, metforminStatus, metforminRisk) {
            // 计算BMI
            const bmi = weight / Math.pow(height / 100, 2);
            
            // 计算造影剂用量
            let contrastVolume;
            let maxVolume;
            
            if (examType === 'coronary') {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85);
                maxVolume = 60;
            } else {
                contrastVolume = weight * (heartRate <= 80 ? 0.8 : 0.85) + 15;
                maxVolume = 75;
            }

            // 二甲双胍患者的造影剂用量调整
            let contrastAdjustment = '';
            if (metforminRisk && metforminRisk.eGFR < 60) {
                const reductionFactor = metforminRisk.eGFR < 45 ? 0.8 : 0.9;
                const originalVolume = contrastVolume;
                contrastVolume = contrastVolume * reductionFactor;
                contrastAdjustment = `肾功能不全调整：${originalVolume.toFixed(1)}ml → ${contrastVolume.toFixed(1)}ml`;
            }

            // 应用最大用量限制
            const isVolumeExceeded = contrastVolume > maxVolume;
            const originalVolume = contrastVolume;
            if (isVolumeExceeded) {
                contrastVolume = maxVolume;
            }

            // 计算注射流速
            let flowRate = examType === 'coronary' ? 
                contrastVolume / 12 : 
                (contrastVolume - 15) / 12;

            const isFlowRateExceeded = flowRate > 5.0;
            const originalFlowRate = flowRate;
            if (isFlowRateExceeded) {
                flowRate = 5.0;
            }

            return {
                height, weight, heartRate, examType, bmi,
                contrastVolume, flowRate, maxVolume,
                isVolumeExceeded, originalVolume,
                isFlowRateExceeded, originalFlowRate,
                metforminStatus, metforminRisk,
                contrastAdjustment,
                timestamp: new Date()
            };
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('calculationResults');
            
            // BMI评估
            let bmiStatus, bmiClass;
            if (results.bmi < 18.5) {
                bmiStatus = '偏瘦';
                bmiClass = 'limit-warning';
            } else if (results.bmi < 24) {
                bmiStatus = '正常';
                bmiClass = 'normal-info';
            } else if (results.bmi < 28) {
                bmiStatus = '超重';
                bmiClass = 'limit-warning';
            } else {
                bmiStatus = '肥胖';
                bmiClass = 'limit-warning';
            }

            const examTypeText = results.examType === 'coronary' ? '冠脉CTA' : '胸痛三联';
            const heartRateText = results.heartRate <= 80 ? '≤80 次/分' : '>80 次/分';
            
            let metforminStatusText = '';
            switch(results.metforminStatus) {
                case 'yes': metforminStatusText = '是，有服用'; break;
                case 'no': metforminStatusText = '否，未服用'; break;
                case 'unknown': metforminStatusText = '不确定'; break;
            }

            // 二甲双胍风险评估结果
            let metforminAssessment = '';
            if (results.metforminRisk) {
                const risk = results.metforminRisk;
                let riskColor = '';
                
                switch(risk.riskLevel) {
                    case 'low': riskColor = '#22c55e'; break;
                    case 'moderate': riskColor = '#f59e0b'; break;
                    case 'high': riskColor = '#ef4444'; break;
                    case 'very-high': riskColor = '#dc2626'; break;
                }

                metforminAssessment = `
                    <div class="result-item">
                        <span class="result-label">🧪 血肌酐值</span>
                        <span class="result-value">${risk.creatinine} μmol/L</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">🔬 eGFR (2021版CKD-EPI)</span>
                        <span class="result-value">${risk.eGFR} ml/min/1.73m²</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">⚗️ 计算方法</span>
                        <span class="result-value" style="font-size: 0.9em;">${risk.calculationMethod}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">⚠️ 二甲双胍风险等级</span>
                        <span class="result-value" style="color: ${riskColor};">${risk.clinicalAction}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">📈 风险评分</span>
                        <span class="result-value">${risk.riskScore.toFixed(1)} 分</span>
                    </div>
                    <div class="${risk.riskLevel === 'low' ? 'normal-info' : 'metformin-alert'}">
                        <strong>🏥 临床处理建议：</strong><br>
                        ${risk.recommendations.map(rec => `• ${rec}`).join('<br>')}
                    </div>
                `;
            } else if (results.metforminStatus === 'unknown') {
                metforminAssessment = `
                    <div class="metformin-alert">
                        <strong>🚨 用药史不明确 - 按高风险处理：</strong><br>
                        • 强烈建议详细询问患者糖尿病用药史<br>
                        • 如无法确认，建议造影前48-72小时停用所有降糖药<br>
                        • 必要时内分泌科会诊
                    </div>
                `;
            } else {
                metforminAssessment = `
                    <div class="normal-info">
                        <strong>✅ 无二甲双胍相关风险</strong><br>
                        患者未服用二甲双胍，可按标准流程进行造影检查。
                    </div>
                `;
            }
            
            // 生成限制提示
            let limitWarning = '';
            if (results.isVolumeExceeded) {
                limitWarning += `
                    <div class="limit-warning">
                        <strong>🚨 造影剂用量限制提示：</strong><br>
                        理论计算用量：${results.originalVolume.toFixed(1)}ml<br>
                        安全限制用量：${results.contrastVolume.toFixed(1)}ml（${examTypeText}最大用量：${results.maxVolume}ml）<br>
                        <strong>建议：</strong>已应用安全上限，请结合患者具体情况评估。
                    </div>
                `;
            }
            
            if (results.isFlowRateExceeded) {
                limitWarning += `
                    <div class="limit-warning">
                        <strong>🚨 注射流速限制提示：</strong><br>
                        理论计算流速：${results.originalFlowRate.toFixed(2)}ml/s<br>
                        安全限制流速：${results.flowRate.toFixed(2)}ml/s（最大流速：5.0ml/s）<br>
                        <strong>建议：</strong>已应用安全上限，可考虑延长注射时间或调整方案。
                    </div>
                `;
            }

            if (results.contrastAdjustment) {
                limitWarning += `
                    <div class="limit-warning">
                        <strong>🩺 肾功能调整提示：</strong><br>
                        ${results.contrastAdjustment}<br>
                        <strong>原因：</strong>肾功能不全患者减少造影剂用量以降低肾毒性风险。
                    </div>
                `;
            }
            
            resultsContent.innerHTML = `
                <div class="calc-type">
                    计算模式：${examTypeText} | 心率：${heartRateText} | 二甲双胍：${metforminStatusText}
                    <div style="float: right; font-size: 12px;">
                        计算时间：${results.timestamp.toLocaleString()}
                    </div>
                </div>
                
                <div class="result-item">
                    <span class="result-label">📏 身高</span>
                    <span class="result-value">${results.height} cm</span>
                </div>
                <div class="result-item">
                    <span class="result-label">⚖️ 体重</span>
                    <span class="result-value">${results.weight} kg</span>
                </div>
                <div class="result-item">
                    <span class="result-label">📊 BMI指数</span>
                    <span class="result-value">${results.bmi.toFixed(2)}</span>
                </div>
                
                <div class="${bmiClass}">
                    <strong>BMI评估：</strong>${bmiStatus}
                </div>
                
                ${metforminAssessment}
                
                <div class="result-item">
                    <span class="result-label">💉 造影剂用量</span>
                    <span class="result-value" style="color: ${results.isVolumeExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.contrastVolume.toFixed(1)} ml
                    </span>
                </div>
                <div class="result-item">
                    <span class="result-label">⚡ 注射流速</span>
                    <span class="result-value" style="color: ${results.isFlowRateExceeded ? '#ef4444' : '#4f46e5'};">
                        ${results.flowRate.toFixed(2)} ml/s
                    </span>
                </div>
                
                ${limitWarning}
                
                <div class="normal-info">
                    <strong>📋 计算依据：</strong><br>
                    <strong>eGFR公式：</strong>2021版CKD-EPI肾小球滤过率方程（无种族系数，直接使用μmol/L）<br>
                    <strong>造影剂用量：</strong>${results.examType === 'coronary' ? 
                        (results.heartRate <= 80 ? '冠脉CTA心率≤80：体重×0.8ml/kg' : '冠脉CTA心率>80：体重×0.85ml/kg') :
                        (results.heartRate <= 80 ? '胸痛三联心率≤80：体重×0.8ml/kg + 15ml' : '胸痛三联心率>80：体重×0.85ml/kg + 15ml')
                    }<br>
                    <strong>注射流速：</strong>${results.examType === 'coronary' ? '用量÷12s' : '(用量-15ml)÷12s'}<br>
                    <strong>安全限制：</strong>${results.examType === 'coronary' ? '冠脉CTA最大60ml' : '胸痛三联最大75ml'}，流速最大5.0ml/s<br>
                    <strong>设备依据：</strong>联影CT960+设备技术参数<br>
                    <strong>程序版本：</strong>v2.1 修正版eGFR计算
                </div>
            `;
            
            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // PDF导出功能
        function exportToPDF() {
            if (!appState.currentResults) {
                showNotification('⚠️ 没有可导出的计算结果', 'warning');
                return;
            }
            
            try {
                const results = appState.currentResults;
                
                const pdfWindow = window.open('', '_blank');
                if (!pdfWindow) {
                    if (confirm('浏览器阻止了弹窗，是否下载文本格式的报告？')) {
                        generateTextReport();
                    } else {
                        showNotification('💡 请允许此网站的弹窗功能以导出PDF', 'info');
                    }
                    return;
                }
                
                const pdfContent = generatePDFContent(results);
                
                pdfWindow.document.write(pdfContent);
                pdfWindow.document.close();
                
                pdfWindow.onload = function() {
                    setTimeout(() => {
                        pdfWindow.print();
                        showNotification('💡 请在打印对话框中选择"保存为PDF"', 'info');
                    }, 500);
                };
                
                showNotification('✅ PDF导出窗口已打开', 'success');
                
            } catch (error) {
                console.error('PDF导出出错:', error);
                showNotification('❌ PDF导出失败，请重试', 'error');
            }
        }

        // 生成PDF优化的HTML内容
        function generatePDFContent(results) {
            const currentDate = new Date().toLocaleString();
            
            let bmiStatus = '';
            if (results.bmi < 18.5) bmiStatus = '偏瘦';
            else if (results.bmi < 24) bmiStatus = '正常';
            else if (results.bmi < 28) bmiStatus = '超重';
            else bmiStatus = '肥胖';
            
            const examTypeText = results.examType === 'coronary' ? '冠脉CTA' : '胸痛三联';
            const heartRateText = results.heartRate <= 80 ? '≤80次/分' : '>80次/分';
            
            let metforminSection = '';
            if (results.metforminRisk) {
                const risk = results.metforminRisk;
                metforminSection = `
                    <div class="section compact-section">
                        <h3>二甲双胍风险评估</h3>
                        <table class="data-table">
                            <tr><td>血肌酐值</td><td>${risk.creatinine} μmol/L</td></tr>
                            <tr><td>eGFR</td><td>${risk.eGFR} ml/min/1.73m²</td></tr>
                            <tr><td>风险等级</td><td>${risk.clinicalAction}</td></tr>
                            <tr><td>风险评分</td><td>${risk.riskScore.toFixed(1)} 分</td></tr>
                        </table>
                        <div class="recommendations">
                            <h4>处理建议：</h4>
                            <ul>${risk.recommendations.slice(0,3).map(rec => `<li>${rec}</li>`).join('')}</ul>
                        </div>
                    </div>
                `;
            } else if (results.metforminStatus === 'unknown') {
                metforminSection = `
                    <div class="section compact-section">
                        <h3>二甲双胍风险评估</h3>
                        <div class="warning-box">
                            <strong>⚠️ 用药史不明确</strong><br>
                            建议详细询问用药史，如无法确认按服用处理。
                        </div>
                    </div>
                `;
            } else {
                metforminSection = `
                    <div class="section compact-section">
                        <h3>二甲双胍风险评估</h3>
                        <div class="success-box">
                            <strong>✅ 无相关风险</strong><br>
                            未服用二甲双胍，按标准流程检查。
                        </div>
                    </div>
                `;
            }
            
            let warningSection = '';
            if (results.isVolumeExceeded || results.isFlowRateExceeded || results.contrastAdjustment) {
                let warnings = [];
                
                if (results.isVolumeExceeded) {
                    warnings.push(`造影剂用量限制：理论计算${results.originalVolume.toFixed(1)}ml → 安全限制${results.contrastVolume.toFixed(1)}ml`);
                }
                
                if (results.isFlowRateExceeded) {
                    warnings.push(`注射流速限制：理论计算${results.originalFlowRate.toFixed(2)}ml/s → 安全限制${results.flowRate.toFixed(2)}ml/s`);
                }
                
                if (results.contrastAdjustment) {
                    warnings.push(`肾功能调整：${results.contrastAdjustment}`);
                }
                
                warningSection = `
                    <div class="section compact-section">
                        <h3>安全提示</h3>
                        <div class="warning-box">
                            ${warnings.map(w => `<div>• ${w.length > 40 ? w.substring(0, 40) + '...' : w}</div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>影像学术研究计算报告 v2.1</title>
    <style>
        @page { size: A4; margin: 1.5cm; }
        body { font-family: 'Microsoft YaHei', 'SimSun', sans-serif; line-height: 1.4; color: #333; max-width: 800px; margin: 0 auto; padding: 10px; font-size: 13px; }
        .header { text-align: center; border-bottom: 2px solid #4f46e5; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { color: #4f46e5; font-size: 22px; margin-bottom: 8px; }
        .header .subtitle { color: #666; font-size: 13px; margin-bottom: 5px; }
        .header .time-info { font-size: 11px; color: #888; }
        .section { margin-bottom: 18px; page-break-inside: avoid; }
        .section h3 { color: #4f46e5; font-size: 16px; border-left: 3px solid #4f46e5; padding-left: 10px; margin-bottom: 10px; }
        .section h4 { color: #333; font-size: 14px; margin: 10px 0 8px 0; }
        .data-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .data-table td { padding: 8px 12px; border-bottom: 1px solid #e0e0e0; font-size: 12px; }
        .data-table td:first-child { font-weight: 600; background-color: #f8f9fa; width: 35%; }
        .data-table td:last-child { color: #4f46e5; font-weight: 600; }
        .calc-info { background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #4f46e5; font-size: 11px; line-height: 1.5; }
        .recommendations ul, .warning-box ul, .success-box ul { margin: 8px 0; padding-left: 18px; }
        .recommendations li, .warning-box li, .success-box li { margin-bottom: 3px; font-size: 11px; }
        .warning-box { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; font-size: 11px; }
        .success-box { background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 4px; padding: 10px; font-size: 11px; }
        .footer { margin-top: 20px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #e0e0e0; padding-top: 12px; line-height: 1.4; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .compact-section { margin-bottom: 12px; }
        @media print { body { margin: 0; padding: 0; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>影像学术研究计算结果</h1>
        <div class="subtitle">CTA造影剂用量与BMI学术参考计算（含二甲双胍评估）v2.1</div>
        <div class="time-info">
            计算时间：${results.timestamp.toLocaleString()} | 结果生成时间：${currentDate}
        </div>
    </div>
    
    <div class="two-column">
        <div>
            <div class="section compact-section">
                <h3>患者基本信息</h3>
                <table class="data-table">
                    <tr><td>身高</td><td>${results.height} cm</td></tr>
                    <tr><td>体重</td><td>${results.weight} kg</td></tr>
                    <tr><td>BMI指数</td><td>${results.bmi.toFixed(2)} (${bmiStatus})</td></tr>
                </table>
            </div>
            
            <div class="section compact-section">
                <h3>检查参数</h3>
                <table class="data-table">
                    <tr><td>检查类型</td><td>${examTypeText}</td></tr>
                    <tr><td>心率参数</td><td>${heartRateText}</td></tr>
                    <tr><td>二甲双胍状态</td><td>${results.metforminStatus === 'yes' ? '是，有服用' : results.metforminStatus === 'no' ? '否，未服用' : '不确定'}</td></tr>
                </table>
            </div>
            
            <div class="section compact-section">
                <h3>计算结果</h3>
                <table class="data-table">
                    <tr><td>造影剂用量</td><td>${results.contrastVolume.toFixed(1)} ml</td></tr>
                    <tr><td>注射流速</td><td>${results.flowRate.toFixed(2)} ml/s</td></tr>
                </table>
            </div>
        </div>
        
        <div>
            ${metforminSection}
            ${warningSection}
        </div>
    </div>
    
    <div class="section">
        <h3>计算依据</h3>
        <div class="calc-info">
            <strong>eGFR公式：</strong>2021版CKD-EPI方程（无种族系数）<br>
            <strong>造影剂用量：</strong>${results.examType === 'coronary' ? 
                (results.heartRate <= 80 ? '冠脉CTA：体重×0.8ml/kg' : '冠脉CTA：体重×0.85ml/kg') :
                (results.heartRate <= 80 ? '胸痛三联：体重×0.8ml/kg+15ml' : '胸痛三联：体重×0.85ml/kg+15ml')
            }<br>
            <strong>注射流速：</strong>${results.examType === 'coronary' ? '用量÷12s' : '(用量-15ml)÷12s'} | 
            <strong>安全限制：</strong>${results.examType === 'coronary' ? '最大60ml' : '最大75ml'}，流速≤5.0ml/s
        </div>
    </div>
    
    <div class="footer">
        <p><strong>重要声明：</strong>本结果仅供学术研究参考，严禁用于临床诊断或治疗决策</p>
        <p>工具版本：v2.1 | 开发者：影像涛哥 | 结果编号：${Date.now()}</p>
    </div>
</body>
</html>`;
        }

        // 生成文本格式报告
        function generateTextReport() {
            if (!appState.currentResults) return;
            
            const results = appState.currentResults;
            let bmiStatus = '';
            if (results.bmi < 18.5) bmiStatus = '偏瘦';
            else if (results.bmi < 24) bmiStatus = '正常';
            else if (results.bmi < 28) bmiStatus = '超重';
            else bmiStatus = '肥胖';
            
            const examTypeText = results.examType === 'coronary' ? '冠脉CTA' : '胸痛三联';
            const heartRateText = results.heartRate <= 80 ? '≤80次/分' : '>80次/分';
            
            let metforminSection = '';
            if (results.metforminRisk) {
                const risk = results.metforminRisk;
                metforminSection = `
二甲双胍风险评估
--------------
血肌酐值：${risk.creatinine} μmol/L
eGFR (2021版CKD-EPI)：${risk.eGFR} ml/min/1.73m²
计算方法：${risk.calculationMethod}
风险等级：${risk.clinicalAction}
风险评分：${risk.riskScore.toFixed(1)} 分

临床建议：
${risk.recommendations.map(rec => `• ${rec}`).join('\n')}
`;
            } else if (results.metforminStatus === 'unknown') {
                metforminSection = `
二甲双胍风险评估
--------------
⚠️ 用药史不明确警告
• 强烈建议详细询问患者用药史
• 如无法确认，建议造影前48-72小时停用所有降糖药
• 必要时内分泌科会诊
`;
            } else {
                metforminSection = `
二甲双胍风险评估
--------------
✅ 无二甲双胍相关风险
患者未服用二甲双胍，可按标准流程进行造影检查。
`;
            }
            
            const reportText = `影像学术研究计算结果 v2.1
==============================

计算时间：${results.timestamp.toLocaleString()}
结果生成时间：${new Date().toLocaleString()}

患者基本信息
-----------
身高：${results.height} cm
体重：${results.weight} kg
BMI：${results.bmi.toFixed(2)} (${bmiStatus})

检查参数
--------
检查类型：${examTypeText}
心率参数：${heartRateText}
二甲双胍状态：${results.metforminStatus === 'yes' ? '是，有服用' : results.metforminStatus === 'no' ? '否，未服用' : '不确定'}

计算结果
--------
造影剂用量：${results.contrastVolume.toFixed(1)} ml
注射流速：${results.flowRate.toFixed(2)} ml/s

${metforminSection}

计算依据
--------
eGFR公式：2021版CKD-EPI肾小球滤过率方程（无种族系数，直接使用μmol/L）
造影剂用量：${results.examType === 'coronary' ? 
    (results.heartRate <= 80 ? '冠脉CTA心率≤80：体重×0.8ml/kg' : '冠脉CTA心率>80：体重×0.85ml/kg') :
    (results.heartRate <= 80 ? '胸痛三联心率≤80：体重×0.8ml/kg + 15ml' : '胸痛三联心率>80：体重×0.85ml/kg + 15ml')
}
注射流速：${results.examType === 'coronary' ? '用量÷12s' : '(用量-15ml)÷12s'}
安全限制：${results.examType === 'coronary' ? '冠脉CTA最大60ml' : '胸痛三联最大75ml'}，流速最大5.0ml/s
设备依据：联影CT960+设备技术参数
程序版本：v2.1 修正版eGFR计算

重要声明
--------
本结果仅供学术研究参考，严禁用于临床诊断或治疗决策
工具版本：v2.1 | 开发者：影像涛哥
eGFR计算：采用2021版CKD-EPI公式，直接使用μmol/L单位计算
结果编号：${Date.now()}`;
            
            const dataBlob = new Blob([reportText], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `影像计算结果_v2.1_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
            
            link.addEventListener('click', function() {
                setTimeout(() => URL.revokeObjectURL(url), 100);
            });
            
            link.click();
            showNotification('✅ 文本格式结果已下载', 'success');
        }

        // 通知显示函数
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 20px;
                border-radius: 8px; color: white; font-weight: 500; z-index: 1000;
                opacity: 0; transition: opacity 0.3s ease; max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            switch(type) {
                case 'success': notification.style.background = '#22c55e'; break;
                case 'error': notification.style.background = '#ef4444'; break;
                case 'warning': notification.style.background = '#f59e0b'; break;
                default: notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.opacity = '1', 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                setupRealTimeValidation();
                handleMetforminChange();
                
                document.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !document.getElementById('calculateBtn').disabled) {
                        calculate();
                    }
                });
                
                updateProgress();
                
            } catch (error) {
                console.error('页面初始化出错:', error);
                alert('⚠️ 页面初始化过程中出现问题，部分功能可能无法正常使用');
            }
        });

        // 全局错误处理
        window.addEventListener('error', function(event) {
            console.error('全局错误:', event.error);
            showNotification('❌ 程序运行出现异常，请刷新页面重试', 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('未处理的Promise拒绝:', event.reason);
            showNotification('⚠️ 异步操作失败，请重试', 'warning');
        });
    </script>
</body>
</html>
